/*! 
 * PLAYRTC. PLAYRTC is WebRTC SDK.
 * Copyright 2013, 2015 Heo Youngnam
 * 
 * project: PLAYRTC
 * version: 1.0.6
 * contact: cryingnavi@gmail.com
 * homepage: http://www.playrtc.com
 * Date: 2015-03-25 09:43 
 */
!function(a){var b=a();"object"==typeof module&&"object"==typeof module.exports?module.exports=b:window.PlayRTC=b}(function(){function a(a,b,c){var d=null,e=null;if("CHANNEL"===a)switch(b){case"40102":case"40103":d="C4203",e=n.C4203;break;case"40104":d="C4204",e=n.C4204;break;default:d="C4205",e=n.C4205}else if("SIGNAL"===a)switch(b){case 40102:case 40103:d="S4303",e=n.S4303;break;case 40104:d="S4304",e=n.S4304;break;default:d="S4305",e=n.S4305}this.fire("error",d,e,c)}function b(a,b){var c=null,d=null;switch(a=a.toUpperCase()){case"SVC2003":case"SVC3003":case"SVC3004":case"SVC3101":case"SVC3102":case"SVC3103":case"SVC3110":c="S4401",d=n.S4401;break;default:c="S4407",d=n.S4407}this.fire("error",c,d,b)}function c(a){var b=a.serverConfig.project,c={signalType:"NAG",iceServers:[],channelServer:null,signalServer:null,dataChannelEnabled:!0,logLevel:"TRACE",userMedia:{audio:!0,video:!0}};return b.servers&&("yes"===b.servers.channel.scopeYN&&(c.channelServer="static"===b.servers.channel.supplyType?b.servers.channel.url:b.servers.channel.domain),"yes"===b.servers.signal.scopeYN&&("NAG"===b.servers.signal.supply?c.signalServer="static"===b.servers.signal.supplyType?{rest:b.servers.signal.restfulUrl,webSocket:b.servers.signal.websocketUrl}:{rest:b.servers.signal.restfulDomain,webSocket:b.servers.signal.websocketDomain}:(c.signalType="PlayRTC",c.signalServer=b.servers.signal.websocketDomain))),b.sdk&&(b.sdk.medias&&(c.userMedia.video="yes"===b.sdk.medias.video?!0:"object"==typeof b.sdk.medias.video?b.sdk.medias.video:!1,c.userMedia.audio="yes"===b.sdk.medias.audio?!0:"object"==typeof b.sdk.medias.audio?b.sdk.medias.audio:!1,c.dataChannelEnabled="yes"===b.sdk.medias.dataChannel?!0:!1),b.sdk.log&&(c.logLevel=b.sdk.log.type.toUpperCase())),delete a.serverConfig,l.apply(c,a)}function d(a,b,c){return c=c||"",a&&b?j?(this.connected=!0,c||t.warn("cdm",{method:"_call",channelId:a,message:"Connected without uid"}),t.trace("cdm",{method:"_call",channelId:a,message:"Token["+b+"] UID["+c+"] Called '_call' method"}),this.stateChange("CHANNELING"),this.calling=new u(this,this.config.channelServer,this.config.signalServer,this.ChannelingAdapter,this.SignalingAdapter),this.calling.on("_disconnectChannel",this._disconnectChannel,this).on("_otherDisconnectChannel",this._otherDisconnectChannel,this).on("error",this.error,this).on("stateChange",this.stateChange,this).on("createUserMedia",this.createUserMedia,this).on("addRemoteStream",this.addRemoteStream,this).on("userCommand",this.userCommandCallback,this),this.calling.createChannel(),void this.calling.connect(a,b,c)):(t.error("cndm",{method:"_call",channelId:a,service:"SGL",stateCode:50202,errorCode:40201,isSuccess:"N",message:"Token["+b+"] UID["+c+"] Your device is not supported media"}),this.error("M4001",n.M4001),!1):(t.error("cdm",{method:"_call",channelId:a,message:"Failed to execute '_call' on 'PlayRTC': 2 arguments required, but only "+arguments.length+" present"}),!1)}function e(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;25>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}var f=function(){var a=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.RTCPeerConnection;return a}(),g=function(){var a=window.mozRTCSessionDescription||window.RTCSessionDescription;return a}(),h=function(){var a=window.mozRTCIceCandidate||window.RTCIceCandidate;return a}(),j=function(){var a=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return a}(),k=function(){var a=window.URL||window.webkitURL||window.msURL||window.oURL;return a}(),l={};l.browser=function(){function a(a){var c=b.match(a);return c&&c.length>1&&c[1]||""}var b=navigator.userAgent,c=a(/version\/(\d+(\.\d+)?)/i),d=null;return/chrome|crios|crmo/i.test(b)?d={name:"chrome",version:a(/(?:chrome|crios|crmo)\/([\.1234567890]+)/i)}:/opera|opr/i.test(b)?d={name:"opera",version:c||a(/(?:opera|opr)[\s\/]([\.1234567890]+)/i)}:/msie|trident/i.test(b)?d={name:"ie",version:a(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:/firefox|iceweasel/i.test(b)?d={name:"firefox",version:a(/(?:firefox|iceweasel)[ \/]([\.1234567890]+)/i)}:/safari/i.test(b)&&(d={name:"safari",version:c}),d}(),l.platform=function(){var a=navigator.userAgent.toLowerCase(),b=navigator.platform,c=/iPhone/i.test(b),d=/iPad/i.test(b),e=/iPod/i.test(b),f=/win/i.test(b),g=/mac/i.test(b),h=/linux/i.test(b),i=c||d||e,j=/android/i.test(a);return f?"windows":i?"ios":j?"android":g?"mac":h?"linux":void 0}(),l.Extend=function(a,b){var c=function(){var a=Array.prototype.slice.call(arguments);this.initialize.apply(this,a)},d=function(){},e=a.prototype;if(d.prototype=e,c.prototype=new d,c.prototype.constructor=c,c.base=e,b)for(var f in b)c.prototype[f]=b[f];return c.Extend=function(a){var b=this;return l.Extend(b,a)},c};var m=function(){};l.Event=l.Extend(m,{initialize:function(){this.listeners={}},on:function(a,b,c){this.listeners||(this.listeners={});var d=this.listeners[a]||(this.listeners[a]=[]);return d.push({callback:b,context:c}),this},off:function(a,b,c){var d,e,f,g,h;if(!a&&!b&&!c)return this.listeners=void 0,this;if(f=this.listeners[a]){if(this.listeners[a]=d=[],b||c)for(g=0,h=f.length;h>g;g++)e=f[g],(b&&b!==e.callback||c&&c!==e.context)&&d.push(e);d.length||delete this.listeners[a]}return this},fire:function(a){if(!this.listeners)return this;var b=Array.prototype.slice.call(arguments,1),c=this.listeners[a],d=-1;if(c){var e=c.length;switch(b.length){case 0:if(1===e)return(ev=c[0]).callback.call(ev.context);for(;++d<e;)(ev=c[d]).callback.call(ev.context);return this;default:if(1===e)return(ev=c[0]).callback.apply(ev.context,b);for(;++d<e;)(ev=c[d]).callback.apply(ev.context,b);return this}}return this},clear:function(){this.listeners={}},hasEvent:function(a){return this.listeners[a]?!0:!1}}),l.apply=function(a,b){if(!a||!b)throw new Error("Failed to execute 'apply' on 'utils': 2 arguments required, but only "+arguments.length+" present.");if("object"==typeof b&&("number"==typeof a||"boolean"==typeof a||"string"==typeof a))return a=b;var c=null;for(c in b)a[c]="object"==typeof b[c]&&b[c]&&!b[c].hasOwnProperty("length")?l.apply(a[c]||{},b[c]):b[c];return a},l.bind=function(a,b){if(!a||!b)throw new Error("Failed to execute 'bind' on 'utils': 2 arguments required, but only "+arguments.length+" present.");return function(){a.apply(b,Array.prototype.slice.call(arguments))}},l.fileDownload=function(a,b){var c=document,d=c.createElementNS("http://www.w3.org/1999/xhtml","a"),e=c.createEvent("MouseEvents");d.href=k.createObjectURL(a),d.download=b,e.initEvent("click",!0,!1),d.dispatchEvent(e)},l.createVideo=function(a,b){var c={autoPlay:!0,controls:!0,width:"100%",height:"100%"},d=document.createElement("video");return b=b||{},c=l.apply(c,b),c.controls&&d.setAttribute("controls",!0),c.autoPlay&&d.setAttribute("autoPlay",!0),d.setAttribute("width",c.width),d.setAttribute("height",c.height),d.src=l.createObjectURL(a),d},l.createAudio=function(a,b){var c={autoPlay:!0,controls:!0},d=document.createElement("audio");return b=b||{},c=l.apply(c,b),c.controls&&d.setAttribute("controls",!0),c.autoPlay&&d.setAttribute("autoPlay",!0),d.src=l.createObjectURL(a),d},l.createObjectURL=function(a){return k.createObjectURL(a)},l.blobWorkerSupport=function(){var a=function(){}.toString(),b=new Blob(["this.onmessage = "+a],{type:"application/javascript"});try{b=k.createObjectURL(b);{new Worker(b)}return k.revokeObjectURL(b),!0}catch(c){return!1}}(),l.mediaRecorderSupport=function(a){try{new MediaRecorder(a),l.mediaRecorderSupport=!0}catch(b){l.mediaRecorderSupport=!1}},l.userMediaSupport=!!j||!1,l.exportLog=function(){t.db.exportLog()},l.monitorLogShow=function(){t.monitor.show()},l.debugViewShow=function(){t.monitor.show()},l.monitorLogHide=function(){t.monitor.hide()},l.debugViewHide=function(){t.monitor.hide()},l.strFormat=function(a){for(var b=arguments,c=b.length,d=null,e=0;c>e;e++)d=new RegExp("\\{"+e+"\\}","g"),a=a.replace(d,b[e+1]);return a};var n={M4001:"Unsupported media",M4002:"Don't accept media",C4101:"Failed allocate channel",C4201:"Failed to connect channel's server",C4202:"Already disconnected channel's server",C4203:"Invalid authentication of channel",C4204:"Invalid channel id",C4205:"Channel error",C4206:"Channel's socket error",S4301:"Failed to connect signal's server",S4302:"Already disconnected signal's server",S4303:"Invalid authentication of signal",S4304:"Invalid channel id",S4305:"Signal error",S4306:"Signal's socket error",S4401:"Invalid authentication of signal",S4402:"Failed to connect signal's server",S4403:"Already disconnected signal's server",S4404:"Failed to create sdp",S4405:"Failed to register sdp",S4406:"Failed to register candidate",S4407:"Signal error",S4408:"No answer",P4501:"Failed P2P",P4601:"Failed to create ActiveX"},o={20001:"SUCCESS",40001:"MESSAGE_SYNTAX_ERROR",40101:"PROJECTID_INVALID",40102:"TOKEN_INVALID",40103:"TOKEN_EXPIRED",40104:"CHANNELID_INVALID",40105:"PEERID_INVALID",40106:"UNKNOWN_CONNECTION",40107:"UNKNOWN_COMMAND"},p={50201:"SGL_BEGIN",50202:"SGL_LOCAL_MEDIA",50203:"SGL_LOCAL_PEER",50204:"SGL_CONNECT",50205:"SGL_SDP_SEND",50206:"SGL_SDP_RECEV",50207:"SGL_CANDIDATE_SEND",50208:"SGL_CANDIDATE_RECEV",50209:"SGL_END",50301:"P2P_CONNECT",50401:"DATACHL_CREATION",50402:"DATACHL_SEND",50403:"DATACHL_RECEV",50404:"DATACHL_ON_ERROR"},q={40201:"MEDIA_UNSUPPORTED",40202:"MEDIA_NOT_ACCPTED",40203:"SDP_CREATION_ERROR",40204:"SDP_REGIST_ERROR",40205:"CANDIDATE_REGIST_ERROR",40206:"P2P_FAILED",40207:"P2P_ERROR",40208:"DATACHL_FAILED",40209:"DATACHL_PARSE_FAILED"},r=l.Extend(l.Event,{initialize:function(a){r.base.initialize.call(this),this.socket=new WebSocket(a),this.setEvent()},setEvent:function(){this.socket.onopen=l.bind(function(a){this.fire("open",a)},this),this.socket.onclose=l.bind(function(a){this.fire("close",a)},this),this.socket.onerror=l.bind(function(a){this.fire("error",a)},this),this.socket.onmessage=l.bind(function(a){this.fire("message",a)},this)},send:function(a){try{this.socket.send(a)}catch(b){}},getReadyState:function(){return this.socket.readyState},close:function(){this.socket&&this.socket.close()}}),s=l.Extend(l.Event,{initialize:function(a){this.config={url:"http://www.playrtc.com:5100",serverConfig:null,ring:!1,localVideoTarget:null,remoteVideoTarget:null},s.base.initialize.call(this),l.apply(this.config,a),this.media=null,this.connected=!1,this.broker=new C(this.config.url),this.sdkBroker=new D(this.config.url),t.network.setConfig({playRtc:this,projectKey:(new Date).getTime()}),t.network.sendStorageLog(),this.config.logLevel&&t.setLogLevel(this.config.logLevel),s.Helper.setUrl(this.config.url),t.trace("cdm",{klass:"PlayRTC",method:"initialize",message:"Created instance of 'PlayRTC'"})},_updateConfig:function(a){return this.config=l.apply(c(a),this.config),this.config.logLevel=this.config.logLevel.toUpperCase(),t.setLogLevel(this.config.logLevel),this.config.userMedia.audio||this.config.userMedia.video||this.config.dataChannelEnabled?(t.trace("cdm",{klass:"PlayRTC",method:"_updateConfig",message:"Set config = "+JSON.stringify(this.config)}),this.ChannelingAdapter=v,this.config.signalType=this.config.signalType.toUpperCase(),void(this.SignalingAdapter="NAG"===this.config.signalType?y:w)):void t.error("cdm",{klass:"PlayRTC",method:"_updateConfig",message:"Might be true one of video or audio or dataChannel"})},setSignaling:function(a){this.SignalingAdapter=a},setChanneling:function(a){this.ChannelingAdapter=a},call:function(a,b,c){return this.calling?void t.error("cdm",{klass:"PlayRTC",method:"call",message:"Already connected channel"}):(t.warn("cm",{klass:"PlayRTC",method:"call",message:"call method is going to deplete"}),b=b||e(),c=c||{},this.broker.setRoom(a),this.sdkBroker.setRoom(a),this.broker.setUser(b),this.sdkBroker.setUser(b),void this.sdkBroker.enterRoom(c,l.bind(function(a,b){"success"===b?(this._updateConfig({serverConfig:a.config}),d.call(this,a.channel,a.token,this.sdkBroker.getUser())):this.error("CHANNELING","CREATED")},this)))},createChannel:function(a){function b(b,c,e){t.trace("cdm",{klass:"PlayRTC",method:"createChannel",channelId:b,message:"Token["+c+"] Received createChannel. serverConfig = "+JSON.stringify(e)}),this.fire("connectChannel",b,"create"),this.fire("createChannel",b),this._updateConfig({serverConfig:e});var f=a.peer?a.peer.uid||"":"";d.call(this,b,c,f)}function c(a,b){t.error("cdm",{klass:"PlayRTC",method:"createChannel",message:"Status["+a.status+"] Failed createChannel. data = "+JSON.stringify(b)}),this.error("C4101",n.C4101,b)}return this.calling?void t.error("cdm",{klass:"PlayRTC",method:"createChannel",message:"Already connected channel"}):(t.trace("cdm",{klass:"PlayRTC",method:"createChannel",message:"Called createChannel. data = "+JSON.stringify(a)}),a=a||{},void s.Helper.createChannel(a,l.bind(b,this),l.bind(c,this)))},connectChannel:function(a,b){function c(a,c,e){t.trace("cdm",{klass:"PlayRTC",method:"connectChannel",channelId:a,message:"Token["+c+"] Received connectChannel. serverConfig = "+JSON.stringify(e)}),this.fire("connectChannel",a,"connect"),this._updateConfig({serverConfig:e});var f=b.peer?b.peer.uid||"":"";d.call(this,a,c,f)}function e(a,b){t.error("cdm",{klass:"PlayRTC",method:"connectChannel",message:"Status["+a.status+"] Failed connectChannel. data = "+JSON.stringify(b)}),this.error("C4101",n.C4101,b)}return this.calling?void t.error("cdm",{klass:"PlayRTC",method:"connectChannel",message:"Already connected channel"}):a?(t.trace("cdm",{klass:"PlayRTC",method:"connectChannel",channelId:a,message:"Called connectChannel. data = "+JSON.stringify(b)}),b=b||{},void s.Helper.connectChannel(a,b,l.bind(c,this),l.bind(e,this))):void t.error("cdm",{klass:"PlayRTC",method:"connectChannel",message:"Failed to execute 'connectChannel' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},disconnectChannel:function(){this.connected=!1,this.calling&&(t.trace("cdm",{klass:"PlayRTC",method:"deleteChannel",channelId:this.getChannelId(),message:"Called disconnectChannel."}),this.calling.channeling.disconnectChannel())},deleteChannel:function(){this.connected=!1,this.calling&&(t.trace("cdm",{klass:"PlayRTC",method:"deleteChannel",channelId:this.getChannelId(),message:"Called deleteChannel."}),this.calling.channeling.deleteChannel())},getChannelList:function(a,b){t.trace("cdm",{klass:"PlayRTC",method:"getChannelList",channelId:this.getChannelId(),message:"Called getChannelList"}),s.Helper.getChannelList(a,b)},getChannel:function(a,b,c){return a?(t.trace("cdm",{klass:"PlayRTC",method:"getChannel",channelId:this.getChannelId(),message:"Called getChannel"}),void s.Helper.getChannel(a,b,c)):void t.error("cdm",{klass:"PlayRTC",method:"getChannel",channelId:a,message:"Failed to execute 'getChannel' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},getPeerList:function(a,b,c){return a?(t.trace("cdm",{klass:"PlayRTC",method:"getPeerList",channelId:this.getChannelId(),message:"Called getPeerList"}),void s.Helper.getPeerList(a,b,c)):void t.error("cdm",{klass:"PlayRTC",method:"getPeerList",channelId:a,message:"Failed to execute 'getPeerList' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},getPeer:function(a,b,c,d){return a&&b?(t.trace("cdm",{klass:"PlayRTC",method:"getPeer",channelId:this.getChannelId(),message:"Called getPeer"}),void s.Helper.getPeer(a,b,c,d)):void t.error("cdm",{klass:"PlayRTC",method:"getPeer",channelId:a,message:"Failed to execute 'getPeer' on 'PlayRTC': 2 arguments required, but only "+arguments.length+" present"})},createUserMedia:function(a,b){a=JSON.parse(a);var c={video:{},audio:{}};a?(a.video?this.config.userMedia.video?c.video.optional=a.video:c.video=!1:c.video=this.config.userMedia.video,a.audio?this.config.userMedia.audio?c.audio.optional=a.audio:c.audio=!1:c.audio=this.config.userMedia.audio):c=this.config.userMedia,c.video||c.audio?this.getMedia()||j.call(navigator,c,l.bind(function(a){if(t.trace("cdm",{klass:"PlayRTC",method:"createUserMedia",message:"Got local stream"}),this.hasEvent("addLocalStream")){if(this.fire("addLocalStream",a)===!1&&this.config.localVideoTarget){var c=document.getElementById(this.config.localVideoTarget);c&&(c.hasAttribute("autoPlay")||c.setAttribute("autoPlay",!0),c.src=l.createObjectURL(a))}}else if(this.config.localVideoTarget){var c=document.getElementById(this.config.localVideoTarget);c&&(c.hasAttribute("autoPlay")||c.setAttribute("autoPlay",!0),c.src=l.createObjectURL(a))}this.createMedia(a),b.call(this.calling),"function"==typeof l.mediaRecorderSupport&&l.mediaRecorderSupport(a)},this),l.bind(function(){t.error("cndm",{klass:"PlayRTC",method:"createUserMedia",service:"SGL",stateCode:50202,errorCode:40202,isSuccess:"N",message:"Failed to get local stream"}),this.destroy(),this.error("M4002",n.M4002)},this)):b.call(this.calling)},addRemoteStream:function(a,b,c){if(this.hasEvent("addRemoteStream")){if(this.fire("addRemoteStream",a,b,c)===!1&&this.config.remoteVideoTarget){var d=document.getElementById(this.config.remoteVideoTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.src=l.createObjectURL(c))}}else if(this.config.remoteVideoTarget){var d=document.getElementById(this.config.remoteVideoTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.src=l.createObjectURL(c))}},createMedia:function(a){return this.media=new A(a),this.media},getMedia:function(){return this.media},getConfig:function(){return this.config},getPeerByPeerId:function(a){if(!this.calling)return null;var b=this.calling.peers[a];return b?b.peer:null},getPeerByUserId:function(a){if(!this.calling)return null;var b=null,c=this.calling.peers;for(b in c)if(c[b].uid===a)return c[b].peer;return null},getAllPeer:function(){if(!this.calling)return null;var a=this.calling.peers,b=[],c=null;for(c in a)b.push(a[c].peer);return b},getBroker:function(){return this.broker},getPeerId:function(){return this.calling?this.calling.getPid():void 0},getChannelId:function(){return this.calling?this.calling.getChannelId():void 0},dataSend:function(a,b){t.trace("cdm",{klass:"PlayRTC",method:"dataSend",channelId:this.getChannelId(),message:"Sent data. data = "+a});var c=null,d=null,e=0,f=0,g=null;if(b){if(c=this.getPeerByPeerId(b)||this.getPeerByUserId(b))return g=c.getDataChannel(),void(g&&g.send(a))}else for(d=this.getAllPeer(),f=d.length;f>e;e++)g=d[e].getDataChannel(),g&&g.send(a)},userCommand:function(a,b){if(this.calling){t.trace("cdm",{klass:"PlayRTC",method:"userCommand",channelId:this.getChannelId(),message:"Sent data. data = "+a});var c=null;b?(c=this.getPeerByPeerId(b)||this.getPeerByUserId(b),c&&this.calling.channeling.userCommand(a,[{id:c.id}])):this.calling.channeling.userCommand(a,[])}},userCommandCallback:function(a,b){var c=this.getPeerByPeerId(a);c&&this.fire("userCommand",a,c.uid,b)},hangUp:function(){t.warn("cm",{klass:"PlayRTC",method:"hangUp",message:"HangUp method is going to deplete"}),this.calling&&this.calling.pid&&this.sdkBroker.leaveRoom(this.calling.pid,function(a,b){"success"!==b&&(this.destroy(),this.fire("hangUp"))})},_disconnectChannel:function(a,b){this.destroy(),this.fire("disconnectChannel"),this.fire("hangUp",a,b)},_otherDisconnectChannel:function(a,b){this.fire("otherDisconnectChannel",a,b),this.fire("otherHangUp",a,b)},error:function(a,b,c){this.connected&&this.disconnectChannel(),this.destroy(),this.fire("error",a,b,c)},stateChange:function(a,b,c){this.fire("stateChange",a,b,c)},destroy:function(){if(this.calling){t.trace("cm",{klass:"PlayRTC",method:"hangUp",message:"Destroyed instance of 'PlayRTC'"}),this.calling.destroy(),this.calling=null,this.media&&(this.media.stop(),this.media=null);var a=document.getElementById(this.config.remoteVideoTarget);a&&(a.src="");var b=document.getElementById(this.config.localVideoTarget);b&&(b.src="")}},destroyCall:function(){this.destroy()},accept:function(a){this.calling&&this.calling.accept(a)},reject:function(a){this.calling&&this.calling.reject(a)}});if("ie"===l.browser.name)var s=l.Extend(l.Event,{initialize:function(a){this.config={url:"http://www.playrtc.com:5100",ring:!1,localVideoTarget:null,remoteVideoTarget:null,signalType:"NAG",iceServers:[],channelServer:null,signalServer:null,dataChannelEnabled:!0,logLevel:"TRACE",userMedia:{audio:!0,video:!0},cabUrl:""},s.base.initialize.call(this),l.apply(this.config,a),this.media=null,t.network.setConfig({playRtc:this,projectKey:(new Date).getTime()}),t.network.sendStorageLog(),this.config.logLevel&&t.setLogLevel(this.config.logLevel),s.Helper.setUrl(this.config.url),t.trace("cdm",{klass:"PlayRTC-IE",method:"initialize",message:"Created instance of 'PlayRTC-IE'"}),this.localMedia=null,this.remoteMedia=null,this.dataChannel=null,this._mediaBar(),this._createActiveX()},_createActiveX:function(){try{var a=e(),b=document.createElement("object");b.setAttribute("id",a),b.setAttribute("classid","CLSID:8DF4CE0D-E083-4AD2-B6E3-74180C274F06"),b.setAttribute("width","0"),b.setAttribute("height","0"),b.setAttribute("codebase",this.config.cabUrl+"/PlayRTC.cab#version=1,0,0,1"),document.body.appendChild(b),this.ax=document.getElementById(a),this.ax.initialize(JSON.stringify(this.config)),this.ax.on("onConnectChannel",l.bind(function(a,b,c){t.trace("cdm",{klass:"PlayRTC-IE",method:"onConnectChannel",message:"Called onConnectChannel"}),this.mediaBarHide(),window.setTimeout(l.bind(function(){this.localMedia=new A(this.config.localVideoTarget,1)},this),100),this.fire("connectChannel",b,c)},this)),this.ax.on("onAddLocalStream",l.bind(function(a,b,c,d){t.trace("cdm",{klass:"PlayRTC-IE",method:"onAddLocalStream",message:"Called onAddLocalStream"}),window.setTimeout(l.bind(function(){this.localMedia.setSrc(d)},this),100),this.fire("addLocalStream",b,c,d)},this)),this.ax.on("onAddRemoteStream",l.bind(function(a,b,c,d){t.trace("cdm",{klass:"PlayRTC-IE",method:"onAddRemoteStream",message:"Called onAddRemoteStream"}),this.remoteMedia=new A(this.config.remoteVideoTarget,0),window.setTimeout(l.bind(function(){this.remoteMedia.setSrc(d)},this),2e3),this.fire("addRemoteStream",b,c,d)},this)),this.ax.on("onAddDataStream",l.bind(function(a,b,c,d){t.trace("cdm",{klass:"PlayRTC-IE",method:"onAddDataStream",message:"Called onAddDataStream"}),window.setTimeout(l.bind(function(){this.dataChannel=new B(d),this.fire("addDataStream",b,c,this.dataChannel)},this),100)},this)),this.ax.on("onDisconnectChannel",l.bind(function(){t.trace("cdm",{klass:"PlayRTC-IE",method:"onDisconnectChannel",message:"Called onDisconnectChannel"}),window.setTimeout(l.bind(function(){this.destroy(),this.fire("disconnectChannel")},this),100)},this)),this.ax.on("onOtherDisconnectChannel",l.bind(function(a,b,c){t.trace("cdm",{klass:"PlayRTC-IE",method:"onOtherDisconnectChannel",message:"Called onOtherDisconnectChannel"}),window.setTimeout(l.bind(function(){this.remoteMedia&&(this.remoteMedia.stop(),this.remoteMedia=null),this.fire("otherDisconnectChannel",b,c)},this),100)},this)),this.ax.on("onUserCommand",l.bind(function(a,b,c,d){t.trace("cdm",{klass:"PlayRTC-IE",method:"onUserCommand",message:"Called onUserCommand"}),window.setTimeout(l.bind(function(){this.fire("userCommand",b,c,d)},this),100)},this)),this.ax.on("onRing",l.bind(function(a,b,c){t.trace("cdm",{klass:"PlayRTC-IE",method:"onRing",message:"Called onRing"}),window.setTimeout(l.bind(function(){this.fire("ring",b,c)},this),100)},this)),this.ax.on("onAccept",l.bind(function(a,b,c){t.trace("cdm",{klass:"PlayRTC-IE",method:"onAccept",message:"Called onAccept"}),window.setTimeout(l.bind(function(){this.fire("accpet",b,c)},this),100)},this)),this.ax.on("onReject",l.bind(function(a,b,c){t.trace("cdm",{klass:"PlayRTC-IE",method:"onReject",message:"Called onReject"}),window.setTimeout(l.bind(function(){this.fire("reject",b,c)},this),100)},this)),this.ax.on("onError",l.bind(function(a,b,c,d){t.trace("cdm",{klass:"PlayRTC-IE",method:"onError",message:"Called onError"}),window.setTimeout(l.bind(function(){this.error(b,c,d)},this),100)},this)),this.ax.on("onStateChange",l.bind(function(a,b,c,d){t.trace("cdm",{klass:"PlayRTC-IE",method:"onStateChange",message:"Called onStateChange"}),window.setTimeout(l.bind(function(){this.stateChange(d,b,c)},this),100)},this))}catch(c){this.error("P4601",n.P4601)}},createChannel:function(a){t.trace("cdm",{klass:"PlayRTC-IE",method:"createChannel",message:"Called createChannel"}),a=JSON.stringify(a),a=a||"{}",this.mediaBarShow(),document.getElementById("playrtc-mediabar-accept").onclick=l.bind(function(){return this.ax.createChannel(a),!1},this)},connectChannel:function(a,b){t.trace("cdm",{klass:"PlayRTC-IE",method:"connectChannel",message:"Called connectChannel"}),b=JSON.stringify(b),b=b||"{}",this.mediaBarShow(),document.getElementById("playrtc-mediabar-accept").onclick=l.bind(function(){return this.ax.connectChannel(a,b),!1},this)},disconnectChannel:function(a){if(this.ax){t.trace("cdm",{klass:"PlayRTC-IE",method:"disconnectChannel",message:"Called disconnectChannel"});try{a=a||this.ax.getPeerId(),a&&window.setTimeout(l.bind(function(){this.ax.disconnectChannel(a)},this),10)}catch(b){}}},deleteChannel:function(){if(this.ax){t.trace("cdm",{klass:"PlayRTC-IE",method:"deleteChannel",message:"Called deleteChannel"});try{window.setTimeout(l.bind(function(){this.ax.deleteChannel()},this),10)}catch(a){}}},getChannelList:function(a,b){t.trace("cdm",{klass:"PlayRTC-IE",method:"getChannelList",message:"Called getChannelList"}),s.Helper.getChannelList(a,b)},getChannel:function(a,b,c){return a?(t.trace("cdm",{klass:"PlayRTC-IE",method:"getChannel",message:"Called getChannel"}),void s.Helper.getChannel(a,b,c)):void t.error("cdm",{klass:"PlayRTC-IE",method:"getChannel",message:"Failed to execute 'getChannel' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},getPeerList:function(a,b,c){return a?(t.trace("cdm",{klass:"PlayRTC-IE",method:"getPeerList",message:"Called getPeerList"}),void s.Helper.getPeerList(a,b,c)):void t.error("cdm",{klass:"PlayRTC-IE",method:"getPeerList",message:"Failed to execute 'getPeerList' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},getPeer:function(a,b,c,d){return a&&b?(t.trace("cdm",{klass:"PlayRTC-IE",method:"getPeer",message:"Called getPeer"}),void s.Helper.getPeer(a,b,c,d)):void t.error("cdm",{klass:"PlayRTC-IE",method:"getPeer",message:"Failed to execute 'getPeer' on 'PlayRTC': 2 arguments required, but only "+arguments.length+" present"})},getChannelId:function(){return this.ax?this.ax.getChannelId():void 0},_mediaBar:function(){if(!document.getElementById("playrtc-bar-style")){var a=[".playrtc-mediabar{display:none;height: 40px;position: fixed;top: 0px;left: 0px;width: 100%;z-index: 9999999;background: #eee;padding: 10px;}",".playrtc-overlay{display:none;background: #000;opacity: 0.3;width: 100%;height: 100%;position: absolute;top: 0px;left: 0px;}",".playrtc-mediabar button{float:right;margin-right:10px;}",".playrtc-mediabar span{font-size: 16px;font-weight: bold;}"],b=document.createElement("style"),c=document.createElement("div"),d=document.createElement("div");b.id="playrtc-bar-style",c.className="playrtc-mediabar",d.className="playrtc-overlay",b.innerHTML=a.join(" "),c.innerHTML='<span>사용자의 미디어를 사용하려고 합니다.</span><button id="playrtc-mediabar-reject">거부</button><button id="playrtc-mediabar-accept">허용</button>',window.addEventListener("load",l.bind(function(){return document.head.appendChild(b),document.body.appendChild(c),document.body.appendChild(d),document.getElementById("playrtc-mediabar-reject").addEventListener("click",l.bind(function(){return this.mediaBarHide(),t.error("cndm",{klass:"PlayRTC-IE",method:"createUserMedia",service:"SGL",stateCode:50202,errorCode:40202,isSuccess:"N",message:"Failed to get local stream"}),this.destroy(),this.error("M4002",n.M4002),!1},this)),!1},this),!1),this.bar=c,this.overlay=d}},mediaBarShow:function(){this.bar.style.display="block",this.overlay.style.display="block"},mediaBarHide:function(){this.bar.style.display="none",this.overlay.style.display="none"},destroy:function(){this.ax&&(this.localMedia&&this.localMedia.stop(),this.remoteMedia&&this.remoteMedia.stop(),this.localMedia=null,this.remoteMedia=null)},error:function(a,b,c){this.fire("error",a,b,c),this.disconnectChannel()},stateChange:function(a,b,c){this.fire("stateChange",a,b,c)},getPeerId:function(){if(this.ax)try{return this.ax.getPeerId()}catch(a){return null}},getLocalMedia:function(){return this.localMedia},getRemoteMedia:function(){return this.remoteMedia},userCommand:function(a){this.ax&&(peerId=this.ax.getPeerId(),this.ax.userCommand(peerId,a))},dataSend:function(a){this.dataChannel&&(a.size&&a.type&&a.name?window.setTimeout(l.bind(function(){this.dataChannel.sendFile(a,function(){console.log("File Success")},function(){console.log("File Fail")})},this),10):window.setTimeout(l.bind(function(){this.dataChannel.sendText(a,function(){console.log("Text Success")},function(){console.log("Text Fail")})},this),10))},accept:function(a){return peerid?(t.trace("cdm",{klass:"PlayRTC-IE",method:"accept",message:"OtherPID["+peerid+"] Accepted other peer"}),void(this.ax&&this.ax.accept(a))):(t.error("cdm",{klass:"PlayRTC-IE",method:"accept",message:"Failed to execute 'accept' on 'PlayRTC-IE': 1 arguments required, but only "+arguments.length+" present"}),!1)},reject:function(){return peerid?(t.trace("cdm",{klass:"PlayRTC-IE",method:"reject",message:"OtherPID["+peerid+"] Rejected other peer"}),void(this.ax&&this.ax.accept(reject))):(t.error("cdm",{klass:"PlayRTC-IE",method:"reject",message:"Failed to execute 'accept' on 'PlayRTC-IE': 1 arguments required, but only "+arguments.length+" present"}),!1)},startStatMonitor:function(a){return this.ax?this.ax.startStatMonitor(a):void 0},stopStatMonitor:function(){return this.ax?this.ax.stopStatMonitor():void 0},getStatMonitorFileName:function(){return this.ax?this.ax.getStatMonitorFileName():void 0}});var t=function(){try{indexedDB.deleteDatabase("PlayRTC")}catch(a){}var b=l.Extend(m,{initialize:function(){},trace:function(){},warn:function(){},error:function(){},dateFormat:function(a){var b=a.getFullYear().toString(),c=(a.getMonth()+1).toString(),d=a.getDate().toString(),e=a.getHours().toString(),f=a.getMinutes().toString(),g=a.getSeconds().toString(),h=a.getMilliseconds();return l.strFormat("{0}/{1}/{2} {3}:{4}:{5}.{6}",b,function(){return c[1]?c:"0"+c[0]},function(){return d[1]?d:"0"+d[0]},function(){return e[1]?e:"0"+e[0]},function(){return f[1]?f:"0"+f[0]},function(){return g[1]?g:"0"+g[0]},function(){return 10>h?h="00"+h:100>h&&(h="0"+h),h})}}),c=function(a,c){var d,e=null;return s.loggers[a]?e=s.loggers[a]:(d=l.Extend(b,c),e=s.loggers[a]=new d),e};s.loggers={};var d=function(a){this.req=new XMLHttpRequest,this.req.onreadystatechange=l.bind(function(a){var b=a.target;4===b.readyState&&200!==b.status&&this.error()},this),this.logger=a,this.log=null,this.projectKey=a.config.projectKey};return function(a){a.send=function(a){this.log=a,this.prepareSend(),this.req.send(JSON.stringify(this.log))},a.prepareSend=function(){this.req.open("post",this.logger.playRtc.config.url+"/v2/playrtc/monitoring-log",!0),"firefox"===l.browser.name&&this.req.setRequestHeader("Accept","application/json"),this.req.setRequestHeader("Content-Type","application/json; charset=UTF-8")},a.error=function(){this.logger.setStorage(this.log)}}(d.prototype),{level:0,LOGLEVEL:{TRACE:0,WARN:1,ERROR:2,NONE:3},typeEach:function(a,b){for(var c=null,d=a.length,e=null;d--;){switch(c=a[d].toUpperCase()){case"C":e=t.console;break;case"N":e=t.network;break;case"D":e=t.db;break;case"M":e=t.monitor}e&&b.call(e),e=null}},trace:function(a,b){this.LOGLEVEL.TRACE<this.level||(b.type="TRACE",this.typeEach(a,function(){this.trace(b)}))},warn:function(a,b){this.LOGLEVEL.WARN<this.level||(b.type="WARN",this.typeEach(a,function(){this.warn(b)}))},error:function(a,b){this.LOGLEVEL.ERROR<this.level||(b.type="ERROR",this.typeEach(a,function(){this.error(b)
}))},setLogLevel:function(a){this.level=this.LOGLEVEL[a],this.level||(this.level=0)},console:c("console",{initialize:function(){this.console=window.console},trace:function(a){this.console.debug(this.format(a))},warn:function(a){this.console.warn(this.format(a))},error:function(a){this.console.error(this.format(a))},format:function(a){var b=this.dateFormat(new Date),c="["+a.type+"]",d=a.channelId?"["+a.channelId+"]":"",e=a.klass?"["+a.klass+"]":"",f=a.method?"["+a.method+"]":"",g=a.message||"";return l.strFormat("{0} {1} {2} {3} {4} {5}",b,c,d,e,f,g).replace(/(?:\s\s)+/g," ")}}),monitor:c("monitor",{initialize:function(){function a(){}this.view={setLog:a,show:a,hide:a,exportLog:a,trace:a,error:a,warn:a}},show:function(){this.view.show()},hide:function(){this.view.hide()},trace:function(a){this.view.trace(this.format(a))},warn:function(a){this.view.warn(this.format(a))},error:function(a){this.view.error(this.format(a))},format:function(a){var b=this.dateFormat(new Date),c="["+a.type+"]",d=a.channelId?"["+a.channelId+"]":"",e=a.klass?"["+a.klass+"]":"",f=a.method?"["+a.method+"]":"",g=a.message||"";return l.strFormat("{0} {1} {2} {3} {4} {5}",b,c,d,e,f,g).replace(/(?:\s\s)+/g," ")}}),db:c("db",{initialize:function(){this.db=null,this.logsData=[];try{window.openDatabase&&(this.db=openDatabase("PlayRTC","1.0","PlayRTC Log Database",20910080),this.db.transaction(function(a){a.executeSql("select * from logs",[],function(){var b="delete from logs where logdate < datetime('now', '-10 day')";a.executeSql(b)},function(a){var b="create table if not exists logs (id integer primary key autoincrement,logdate datetime default current_time, log text)";a.executeSql(b)})}))}catch(a){}},trace:function(a){this.save(this.format(a))},warn:function(a){this.save(this.format(a))},error:function(a){this.save(this.format(a))},save:function(a){try{this.db.transaction(function(b){var c="insert into logs(log) values (?)";b.executeSql(c,[a])})}catch(b){}},exportLog:function(){try{this.db.transaction(l.bind(function(a){var b="select * from logs;";a.executeSql(b,[],l.bind(function(a,b){for(var c=null,d=0;d<b.rows.length;d++)c=b.rows.item(d),this.logsData.push(c.log+"\r\n");b.rows.length&&this.processEnd()},this))},this))}catch(a){}},processEnd:function(){var a=new Blob(this.logsData,{type:"text/plain"});this.logsData=[],l.fileDownload(a,this.dateFormat(new Date)+"_log.txt")},format:function(a){var b=this.dateFormat(new Date),c="["+a.type+"]",d=a.channelId?"["+a.channelId+"]":"",e=a.klass?"["+a.klass+"]":"",f=a.method?"["+a.method+"]":"",g=a.message||"";return l.strFormat("{0} {1} {2} {3} {4} {5}",b,c,d,e,f,g)}}),network:c("network",{initialize:function(){this.config={projectKey:null,interval:6e4},this.storage=window.localStorage,this.q=[]},trace:function(a){var b=new d(this);b.send(this.format(a))},warn:function(a){var b=new d(this);b.send(this.format(a))},error:function(a){var b=new d(this);b.send(this.format(a))},format:function(a){var b=this.dateFormat(new Date),c={date:b,sender:"SDKC",service:"",processLevel:"",isSuccess:"",errorCode:"",token:"",channelId:"",myPeerId:"",myUserId:"",yourPeerId:"",yourUserId:"",platformType:l.platform,browserName:l.browser.name,browserVersion:l.browser.version,networkType:"wired",sdkType:"web",sdkVersion:s.version};return a=l.apply(c,a),a.processLevel=p[a.stateCode]?a.stateCode:"",a.errorCode=q[a.errorCode]?a.errorCode:"",delete a.message,delete a.type,delete a.stateCode,delete a.klass,delete a.method,delete a.channelId,a},setStorage:function(a){this.q.push(a),this.storage.removeItem(this.storageKey),this.storage.setItem(this.storageKey,JSON.stringify(this.q))},sendStorageLog:function(){this.timer&&(window.clearTimeout(this.timer),this.timer=null);var a=this.storage.getItem(this.storageKey),b=null,c=null;if(!a)return void(this.timer=window.setTimeout(l.bind(this.sendStorageLog,this),this.config.interval));if(this.q=[],b=JSON.parse(a),c=b.shift()){var e=new d(this);e.send(c),this.storage.setItem(this.storageKey,JSON.stringify(b)),this.timer=window.setTimeout(l.bind(this.sendStorageLog,this),100)}else this.storage.removeItem(this.storageKey),this.timer=window.setTimeout(l.bind(this.sendStorageLog,this),this.config.interval)},setConfig:function(a){l.apply(this.config,a),this.playRtc=a.playRtc,this.storageKey="storage_"+a.projectKey,this.timer&&(window.clearTimeout(this.timer),this.timer=null),this.timer=window.setTimeout(l.bind(this.sendStorageLog,this),this.config.interval)}})}}(),u=l.Extend(l.Event,{initialize:function(a,b,c,d,e){u.base.initialize.call(this);this.pid=null,this.token=null,this.uid=null,this.peers={},this.playRtc=a,this.channelServer=b,this.signalServer=c,this.channelId=null,this.SignalingAdapter=e,this.channelingTimer=null,this.signalingTimer=null,this.nagTimer=null,this.createOfferTimer=null,"NAG"===this.playRtc.config.signalType&&(this.nagMgr=new x(c,this),this.nagMgr.on("nagTurnList",function(a){this.playRtc.config.iceServers=a},this).on("receiveNagOfferSdp",this.receiveNagOfferSdp,this).on("receiveNagAnwserSdp",this.receiveNagAnwserSdp,this).on("receiveNagCandidate",this.receiveNagCandidate,this)),t.trace("cdm",{klass:"Call",method:"initialize",message:"Created instance of 'Call'"})},createChannel:function(){this.channeling=new v(this,this.channelServer),this.channeling.on("connect",this.afterConnect,this).on("notiRegistration",this.notiRegistration,this).on("afterRing",this.afterRing,this).on("afterAccept",this.afterAccept,this).on("afterReject",this.afterReject,this).on("afterClose",this.afterClose,this).on("afterOtherClose",this.afterOtherClose,this).on("error",this.error,this).on("userCommand",this.userCommandCallback,this),this.channeling.createChannel()},connect:function(a,b,c){function d(a){this.channelingTimer=window.setInterval(l.bind(function(){1===this.channeling.socket.getReadyState()&&(window.clearInterval(this.channelingTimer),this.channelingTimer=null,this.channeling.connect(a))},this),10)}return a&&b?(t.trace("cdm",{klass:"Call",method:"connect",channelId:a,message:"Token["+b+"] UID["+c+"] Connected of channel"}),this.setToken(b),this.setUid(c),this.setChannelId(a),void d.call(this,a)):(t.error("cdm",{klass:"Call",method:"connect",channelId:a,message:"Failed to execute 'connect' on 'Call': 2 arguments required, but only "+arguments.length+" present"}),!1)},setChannelId:function(a){this.channelId=a},getChannelId:function(){return this.channelId},accept:function(a){if(!a)return t.error("cdm",{klass:"Call",method:"accept",channelId:this.getChannelId(),message:"Failed to execute 'accept' on 'Call': 1 arguments required, but only "+arguments.length+" present"}),!1;t.trace("cdm",{klass:"Call",method:"accept",channelId:this.getChannelId(),message:"OtherPID["+a+"] Accepted other peer"}),this.createSignaling(a,l.bind(function(a){this.channeling.accept(a)},this));for(attr in this.peers)this.peers[attr].type="answer"},reject:function(a){return a?(t.trace("cdm",{klass:"Call",method:"reject",channelId:this.getChannelId(),message:"OtherPID["+a+"] Rejected other peer"}),delete this.peers[a],void this.channeling.reject(a)):(t.error("cdm",{klass:"Call",method:"reject",channelId:this.getChannelId(),message:"Failed to execute 'reject' on 'Call': 1 arguments required, but only "+arguments.length+" present"}),!1)},createPeer:function(a,b,c){var d=this.playRtc.getConfig(),e=this.playRtc.getMedia(),f=e?e.getStream():null,g=null;return this.peers[a]||(this.peers[a]={}),this.peers[a].peer?void 0:(this.peers[a].uid||(this.peers[a].uid=b||""),g=this.nagMgr?{iceServers:c,dataChannelEnabled:d.dataChannelEnabled}:{iceServers:d.iceServers,dataChannelEnabled:d.dataChannelEnabled},this.peers[a].peer=new z(this,a,this.peers[a].uid,f,g),this.peers[a].peer.on("sendOfferSdp",this.sendOfferSdp,this).on("sendAnswerSdp",this.sendAnswerSdp,this).on("sendCandidate",this.sendCandidate,this).on("addRemoteStream",this.addRemoteStream,this).on("signalEnd",this.signalEnd,this).on("error",this.error,this).on("stateChange",this.stateChange,this),this.peers[a])},createSignaling:function(a,b){function c(a){this.signalingTimer=window.setInterval(l.bind(function(){1===this.signaling.socket.getReadyState()&&(window.clearInterval(this.signalingTimer),this.signalingTimer=null,this.signaling.connect(a),d&&d(a))},this),10)}var d=null,e=null;if(this.peers[a]||(this.peers[a]={}),!this.peers[a].signaling){this.peers[a].uid||"function"==typeof b||(this.peers[a].uid=b||""),"function"==typeof b&&(d=b),e="NAG"===this.playRtc.config.signalType?this.signalServer.webSocket:this.signalServer,this.fire("stateChange","SIGNALING",a,b),this.peers[a].signaling=new this.SignalingAdapter(this,e,a),this.peers[a].signaling.on("receiveSdp",this.receiveSdp,this).on("receiveOfferSdp",this.receiveOfferSdp,this).on("receiveAnwserSdp",this.receiveAnwserSdp,this).on("receiveCandidate",this.receiveCandidate,this).on("notiConnect",this.notiConnect,this).on("connect",this.signalAfterConnect,this).on("error",this.error,this),this.peers[a].signaling.createSignal();c.call(this.peers[a],a)}},signalStart:function(a){function b(){function a(){if(d.getPid()&&d.getToken())t.trace("cndm",{klass:"Call",method:"signalStart",service:"SGL",stateCode:50201,errorCode:20001,isSuccess:"Y",token:d.getToken(),channelId:d.getChannelId(),myPeerId:d.getPid(),myUserId:d.getUid(),yourPeerId:this.peer.id,yourUserId:this.peer.uid,message:"OtherPID["+this.peer.id+"] OtherUID["+this.peer.uid+"] Started signaling with other peer"});else{var a=this.peer.id?d.getToken()?"":40102:40105;t.error("cndm",{klass:"Call",method:"signalStart",service:"SGL",stateCode:50201,errorCode:a,isSuccess:"N",token:d.getToken(),channelId:d.getChannelId(),myPeerId:d.getPid(),myUserId:d.getUid(),yourPeerId:this.peer.id,yourUserId:this.peer.uid,message:"OtherPID["+this.peer.id+"] OtherUID["+this.peer.uid+"] Failed to start signaling with other peer"})}}d.createOfferTimer=window.setInterval(l.bind(function(){1===this.signaling.socket.getReadyState()&&(window.clearInterval(d.createOfferTimer),d.createOfferTimer=null,a.call(this),this.peer.createOffer())},this),1e3)}var c=this.peers[a],d=this;b.call(c,this)},afterConnect:function(a,b,c){this.setPid(a),t.trace("cdm",{klass:"Call",method:"afterConnect",channelId:this.getChannelId(),message:"Channel's connecting is success"}),this.fire("createUserMedia",c,function(){var a=0,c=b.length;if(this.playRtc.config.ring)for(;c>a;a++)this.ring(b[a].id);else if(this.nagMgr)this.nagTimer=window.setInterval(l.bind(function(){this.nagMgr.socket&&1===this.nagMgr.socket.getReadyState()&&(window.clearInterval(this.nagTimer),this.nagTimer=null,c>0&&this.nagMgr.requestTurnServer(l.bind(function(d){for(;c>a;a++)this.createSignaling(b[a].id,b[a].uid),this.createPeer(b[a].id,b[a].uid,d),this.peers[b[a].id].type="offer"},this)))},this),10);else for(;c>a;a++)this.createSignaling(b[a].id,b[a].uid),this.createPeer(b[a].id,b[a].uid),this.peers[b[a].id].type="offer"})},notiRegistration:function(a,b){var c=null;if(!this.playRtc.config.ring){this.createSignaling(a,b);for(c in this.peers)this.peers[c].type="answer"}},ring:function(a){t.trace("cdm",{klass:"Call",method:"ring",channelId:this.getChannelId(),message:"OtherPID["+a+"] Sent to ring to other peer"}),this.channeling.ring(a)},afterRing:function(a,b){return t.trace("cdm",{klass:"Call",method:"afterRing",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+b+"] Received to ring from other peer"}),this.peers[a]={uid:b},this.playRtc.hasEvent("ring")?void this.playRtc.fire("ring",a,b):(alert("You must create ring's event."),!1)},afterAccept:function(a,b){t.trace("cdm",{klass:"Call",method:"afterAccept",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+b+"] Received to accept from other peer"}),this.nagMgr?this.nagMgr.requestTurnServer(l.bind(function(c){this.createPeer(a,b,c),this.createSignaling(a,b),this.peers[a].type="offer"},this)):(this.createPeer(a,b),this.createSignaling(a,b),this.peers[a].type="offer"),this.playRtc.fire("accept",a,b)},afterReject:function(a,b){t.trace("cdm",{klass:"Call",method:"afterReject",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+b+"] Received to reject from other peer"}),this.playRtc.fire("reject",a,b)},setToken:function(a){this.token=a},getToken:function(){return this.token},setPid:function(a){t.trace("cdm",{klass:"Call",method:"setPid",channelId:this.getChannelId(),message:"PID["+a+"] Set self peerid"}),this.pid=a,this.nagMgr&&this.nagMgr.userRegistration()},getPid:function(){return this.pid},setUid:function(a){this.uid=a},getUid:function(){return this.uid},sendOfferSdp:function(a,b){this.peers[a].signaling.sendOfferSdp(a,b)},sendAnswerSdp:function(a,b){this.peers[a].signaling.sendAnswerSdp(a,b)},sendCandidate:function(a,b){this.peers[a].signaling.sendCandidate(a,b)},receiveOfferSdp:function(a,b){var c=this.peers[a].peer;if(!c){if(this.nagMgr)return void this.nagMgr.requestTurnServer(l.bind(function(c){var d=this.createPeer(a,null,c);t.trace("cdm",{klass:"Call",method:"receiveOfferSdp",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer's offer sdp"}),d.createAnswer(b)},this));c=this.createPeer(a).peer}t.trace("cdm",{klass:"Call",method:"receiveOfferSdp",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer's offer sdp"}),c.createAnswer(b)},receiveNagOfferSdp:function(a,b,c){var d=this.peers[a].peer;if(!d){if(this.nagMgr)return void this.nagMgr.requestTurnServer(l.bind(function(d){var e=this.createPeer(a,null,d).peer;t.trace("cdm",{klass:"Call",method:"receiveNagOfferSdp",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer's offer sdp"}),this.peers[a].signaling.setSessionId(c),e.createAnswer(b)},this));d=this.createPeer(a).peer}t.trace("cdm",{klass:"Call",method:"receiveNagOfferSdp",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer's offer sdp"}),this.peers[a].signaling.setSessionId(c),d.createAnswer(b)},receiveAnwserSdp:function(a,b){t.trace("cdm",{klass:"Call",method:"receiveAnwserSdp",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer's anwser sdp"});var c=this.peers[a].peer;c.receiveAnwserSdp(b)},receiveNagAnwserSdp:function(a,b){var c=null,d=null;for(c in this.peers)if(this.peers[c].sessionId&&this.peers[c].sessionId===a){d=this.peers[c].peer;break}t.trace("cdm",{klass:"Call",method:"receiveNagAnwserSdp",channelId:this.getChannelId(),message:"OtherPID["+d.id+"] Received from other Peer's anwser sdp"}),d.receiveAnwserSdp(b)},receiveCandidate:function(a,b){var c=this.peers[a].peer;if(!c){if(this.nagMgr)return void this.nagMgr.requestTurnServer(l.bind(function(c){var d=this.createPeer(a,null,c);t.trace("cdm",{klass:"Call",method:"receiveCandidate",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer's candidate"}),d.receiveCandidate(b)},this));c=this.createPeer(a).peer}t.trace("cdm",{klass:"Call",method:"receiveCandidate",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer's candidate"}),c.receiveCandidate(b)},receiveNagCandidate:function(a,b){var c=null,d=null,e=null;for(c in this.peers)if(this.peers[c].sessionId&&this.peers[c].sessionId===a){e=c,d=this.peers[c];break}t.trace("cdm",{klass:"Call",method:"receiveNagCandidate",channelId:this.getChannelId(),message:"OtherPID["+e+"] Received from other Peer's candidate"}),d&&d.peer.receiveCandidate(b)},addRemoteStream:function(a,b,c){this.fire("addRemoteStream",a,b,c)},signalEnd:function(a){this.peers[a].signaling&&(t.trace("cndm",{klass:"Call",method:"signalEnd",channelId:this.getChannelId(),service:"SGL",stateCode:50209,errorCode:20001,isSuccess:"Y",token:this.getToken(),channelId:this.getChannelId(),myPeerId:this.getPid(),myUserId:this.getUid(),yourPeerId:a,yourUserId:this.peers[a].uid,message:"OtherPID["+a+"] Done signaling with other peer"}),this.peers[a].signaling.signalEnd(a),delete this.peers[a].signaling)},signalAfterConnect:function(a){if(a){{var b=this.peers[a];b.uid}"offer"===b.type&&this.signalStart(a)}},notiConnect:function(a){var b=this.peers[a];"offer"===b.type&&this.signalStart(a)},afterClose:function(a,b){t.trace("cdm",{klass:"Call",method:"afterClose",channelId:this.getChannelId(),message:"Disconnected channel"}),this.fire("_disconnectChannel",a,b)},afterOtherClose:function(a){var b=this.peers[a],c=null;b&&(c=b.uid,t.trace("cdm",{klass:"Call",method:"afterOtherClose",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+c+"] Disconnected with other peer"}),delete this.peers[a],this.fire("_otherDisconnectChannel",a,c))},error:function(a,b,c){this.fire("error",a,b,c)},stateChange:function(a,b,c){this.fire("stateChange",a,b,c)},getNAGMgr:function(){return this.nagMgr},destroy:function(){t.trace("cdm",{klass:"Call",method:"destroy",channelId:this.getChannelId(),message:"Destroyed instance of 'Call'"});var a=null,b=this.peers;this.channeling&&this.channeling.socket.close(),!this.channelingTimer||window.clearInterval(this.channelingTimer),!this.signalingTimer||window.clearInterval(this.signalingTimer),!this.nagTimer||window.clearInterval(this.nagTimer),!this.createOfferTimer||window.clearInterval(this.createOfferTimer);for(a in b)b[a].signaling&&b[a].signaling.socket.close(),b[a].peer&&b[a].peer.close();this.peers={},"NAG"===this.playRtc.config.signalType&&this.nagMgr&&this.nagMgr.destory()},userCommandCallback:function(a,b){this.fire("userCommand",a,b)}});s.Channeling=l.Extend(l.Event,{initialize:function(a,b){s.Channeling.base.initialize.call(this),this.url=b,this.call=a,t.trace("cdm",{klass:"Channeling",method:"initialize",channelId:this.call.getChannelId(),message:"Created instance of 'Channeling'"})},createChannel:function(){t.trace("cdm",{klass:"Channeling",method:"createChannel",channelId:this.call.getChannelId(),message:"WebSocket["+this.url+"] Created instance of 'Channeling Web Socket'"});try{this.socket=new r(this.url)}catch(a){return t.error("cdm",{klass:"Channeling",method:"createChannel",channelId:this.call.getChannelId(),message:"Failed to create instance of 'Channeling Web Socket'"}),void this.fire("error","C4201",n.C4201)}this.socket.on("close",l.bind(function(){t.trace("cdm",{klass:"Channeling",method:"createChannel",channelId:this.call.getChannelId(),message:"Closed 'Channeling Web Socket'"})},this)).on("error",l.bind(function(){t.error("cdm",{klass:"Channeling",method:"createChannel",channelId:this.call.getChannelId(),message:"Caused error 'Channeling Web Socket'"}),this.fire("error","C4206",n.C4206)},this))},send:function(a){1===this.socket.getReadyState()?this.socket.send(a):(t.error("cdm",{klass:"Channeling",method:"send",channelId:this.call.getChannelId(),message:"Already disconnected channel's server"}),this.fire("error","C4202",n.C4202))},connect:function(a){t.trace("cdm",{klass:"Channeling",method:"connect",channelId:this.call.getChannelId(),message:"Sent to connect channel. data = "+a}),this.send(a)},userCommand:function(a){t.trace("cdm",{klass:"Channeling",method:"userCommand",channelId:this.call.getChannelId(),message:"Sent userdefined. data = "+a}),this.send(a)},accept:function(a){t.trace("cdm",{klass:"Channeling",method:"accept",channelId:this.call.getChannelId(),message:"Sent to accept. data = "+a}),this.send(a)},reject:function(a){t.trace("cdm",{klass:"Channeling",method:"reject",channelId:this.call.getChannelId(),message:"Sent to reject. data = "+a}),this.send(a)},notiTypeSend:function(a){this.send(a)},ring:function(a){t.trace("cdm",{klass:"Channeling",method:"ring",channelId:this.call.getChannelId(),message:"Sent to ring. data = "+a}),this.send(a)},disconnectChannel:function(a){t.trace("cdm",{klass:"Channeling",method:"disconnectChannel",channelId:this.call.getChannelId(),message:"Sent to disconnectChannel. data = "+a}),this.send(a)},deleteChannel:function(a){t.trace("cdm",{klass:"Channeling",method:"forceDelete",channelId:this.call.getChannelId(),message:"Sent to forceDelete. data = "+a}),this.send(a)},message:function(){}});var v=s.Channeling.Extend({initialize:function(a,b){v.base.initialize.call(this,a,b)},createChannel:function(){v.base.createChannel.call(this),this.socket.on("message",this.message,this)},serialize:function(a){var b={header:{command:"",commandType:"req",token:"",expireTime:"none",broadcast:"none",sender:{type:"peer",id:"none"},receiver:{type:"server",id:"none"}},body:{}};return JSON.stringify(l.apply(b,a))},connect:function(a){var b="wired";("android"===l.browser.name||"ios"===l.browser.name)&&(b="3g");var c=this.serialize({header:{command:"connect",token:this.call.getToken(),sender:{env:{platformType:l.platform,browser:{name:l.browser.name,version:l.browser.version},sdk:{type:"web",version:s.version},networkType:b}}},body:{data:{uid:this.call.getUid()||"none",channelId:a}}});v.base.connect.call(this,c)},userCommand:function(a,b){var a=this.serialize({header:{command:"userdefined",token:this.call.getToken(),broadcast:b.length<1?"yes":"no",sender:{id:this.call.getPid()},receiver:{targets:b}},body:{data:{channelId:this.call.getChannelId(),userData:a}}});v.base.userCommand.call(this,a)},ring:function(a){var b=this.serialize({header:{command:"ready",token:this.call.getToken(),sender:{id:this.call.getPid()}},body:{data:{channelId:this.call.getChannelId(),targetId:a}}});v.base.ring.call(this,b)},accept:function(a){var b=this.serialize({header:{command:"on_ready",commandType:"res",token:this.call.getToken(),sender:{type:"peer",id:this.call.getPid()}},body:{header:{code:"20001",desc:"SUCCESS"},data:{status:"yes",channelId:this.call.getChannelId(),targetId:a}}});v.base.accept.call(this,b)},reject:function(a){var b=this.serialize({header:{command:"on_ready",commandType:"res",token:this.call.getToken(),sender:{type:"peer",id:this.call.getPid()}},body:{header:{code:"20001",desc:"SUCCESS"},data:{status:"no",channelId:this.call.getChannelId(),targetId:a}}});v.base.reject.call(this,b)},notiTypeConnSend:function(){var a=this.serialize({header:{command:"on_connect",commandType:"res",token:this.call.getToken(),sender:{id:this.call.getPid()}},body:{header:{code:"20002",desc:"SUCCESS"}}});t.trace("cdm",{klass:"Channeling",method:"notiTypeConnSend",channelId:this.call.getChannelId(),message:"Sent 'on_connect'. data = "+a}),v.base.notiTypeSend.call(this,a)},notiTypeCloseSend:function(a){var b=this.serialize({header:{command:"close",commandType:"res",token:this.call.getToken(),sender:{id:this.call.getPid()}},body:{header:{code:"20002",desc:"SUCCESS"},data:{channelId:a}}});t.trace("cdm",{klass:"Channeling",method:"notiTypeCloseSend",channelId:this.call.getChannelId(),message:"Sent to close. data = "+b}),v.base.notiTypeSend.call(this,b)},disconnectChannel:function(){var a=this.serialize({header:{command:"peer_close",token:this.call.getToken(),sender:{id:this.call.getPid()}},body:{data:{channelId:this.call.getChannelId()}}});v.base.disconnectChannel.call(this,a)},deleteChannel:function(){var a=this.serialize({header:{command:"channel_close",token:this.call.getToken(),sender:{id:this.call.getPid()}},body:{data:{channelId:this.call.getChannelId()}}});v.base.deleteChannel.call(this,a)},message:function(b){var c=JSON.parse(b.data),d=c.header,e=c.body,f=d.command.toUpperCase(),g=[],h=0,i=0;if("res"===d.commandType&&"SUCCESS"!==o[e.header.code])return t.error("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received message. data = "+b.data}),void a.call(this,"CHANNEL",e.header.code,c);switch(f){case"CONNECT":for(t.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received channel 'connect'. data = "+b.data}),h=e.data.others.length;h>i;i++)g.push({id:e.data.others[i].id,uid:"none"!==e.data.others[i].uid?e.data.others[i].uid:""});this.fire("connect",d.receiver.id,g,e.data.envConstraints);break;case"ON_CONNECT":t.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received channel 'on_connect'. data = "+b.data}),e.data.others.length>0&&this.fire("notiRegistration",e.data.others[0].id,"none"!==e.data.others[0].uid?e.data.others[0].uid:""),this.notiTypeConnSend();break;case"READY":t.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'ring'. data = "+b.data}),e.data.status&&("yes"===e.data.status?this.fire("afterAccept",e.data.targetId,"none"!==e.data.uid?e.data.uid:""):this.fire("afterReject",e.data.targetId,"none"!==e.data.uid?e.data.uid:""));break;case"ON_READY":t.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Rreceived 'on_ring'. data = "+b.data}),this.fire("afterRing",e.data.targetId,"none"!==e.data.uid?e.data.uid:"");break;case"CLOSE":t.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'close'. data = "+b.data}),this.notiTypeCloseSend(e.data.channelId),this.fire("afterClose",e.data.channelId,d.receiver.id);break;case"ON_CLOSE":t.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'on_close'. data = "+b.data}),this.fire("afterOtherClose",e.data.targetId);break;case"ON_USERDEFINED":t.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'on_userdefined'. data = "+b.data}),this.fire("userCommand",e.data.targetId,e.data.userData)}}});s.Signaling=l.Extend(l.Event,{initialize:function(a,b){s.Signaling.base.initialize.call(this),this.url=b,this.call=a,t.trace("cdm",{klass:"Signaling",method:"initialize",channelId:this.call.getChannelId(),message:"Created instance of 'Signaling'"})},createSignal:function(){t.trace("cdm",{klass:"Signaling",method:"createSignal",channelId:this.call.getChannelId(),message:"WebSocket["+this.url+"] Created instance of 'Signaling Web Socket'"});try{this.socket=new r(this.url)}catch(a){return t.error("cdm",{klass:"Signaling",method:"createSignal",channelId:this.call.getChannelId(),message:"Failed to create instance of 'Signaling Web Socket'"}),void this.fire("error","S4301",n.S4301)}this.socket.on("open",l.bind(function(){t.trace("cdm",{klass:"Signaling",method:"createSignal",channelId:this.call.getChannelId(),message:"Opened signaling socket"})},this)).on("close",l.bind(function(){t.trace("cdm",{klass:"Signaling",method:"createSignal",channelId:this.call.getChannelId(),message:"Closed signaling socket"})},this)).on("error",l.bind(function(){t.error("cdm",{klass:"Signaling",method:"createSignal",channelId:this.call.getChannelId(),message:"Caused signaling socket error"}),this.fire("error","S4306",n.S4306)},this))},send:function(a){1===this.socket.getReadyState()?this.socket.send(a):(t.error("cdm",{klass:"Signaling",method:"send",channelId:this.call.getChannelId(),message:"Already disconnected signal's server"}),this.fire("error","S4302",n.S4302))},serialize:function(a){return a},connect:function(a){t.trace("cdm",{klass:"Signaling",method:"connect",channelId:this.call.getChannelId(),message:"Connected signal. data = "+a}),this.send(a)},sendOfferSdp:function(a){t.trace("cdm",{klass:"Signaling",method:"sendOfferSdp",channelId:this.call.getChannelId(),message:"Sent offer's sdp. data = "+a}),this.send(a)},sendAnswerSdp:function(a){t.trace("cdm",{klass:"Signaling",method:"sendAnswerSdp",channelId:this.call.getChannelId(),message:"Sent answer's sdp. data = "+a}),this.send(a)},sendCandidate:function(a){t.trace("cdm",{klass:"Signaling",method:"sendCandidate",channelId:this.call.getChannelId(),message:"Sent candidate. data = "+a}),this.send(a)},message:function(){},signalEnd:function(a){t.trace("cdm",{klass:"Signaling",method:"signalEnd",channelId:this.call.getChannelId(),message:"Sent signaling end message. data = "+a}),this.send(a)}});var w=s.Signaling.Extend({STATUSCODE:{20001:"SUCCESS"},initialize:function(a,b){w.base.initialize.call(this,a,b),t.trace("cdm",{klass:"SignalingAdapter",method:"initialize",channelId:this.call.getChannelId(),message:"Created instance of 'SignalingAdapter'"})},createSignal:function(){w.base.createSignal.call(this),this.socket.on("message",this.message,this)},serialize:function(a){var b={header:{command:"",commandType:"req",token:this.call.getToken(),sender:{type:"peer",id:"none"},receiver:{type:"peer",id:"none"}},body:{}};return JSON.stringify(l.apply(b,a))},connect:function(a){var b=this.serialize({header:{command:"connect",token:this.call.getToken(),sender:{id:this.call.getPid()},receiver:{type:"server"}},body:{data:{targetId:a}}});w.base.connect.call(this,b)},sendCandidate:function(a,b){var c=this.serialize({header:{command:"candidate",sender:{id:this.call.getPid()},receiver:{id:a}},body:{data:{candidate:JSON.stringify(b)}}});w.base.sendCandidate.call(this,c)},sendOfferSdp:function(a,b){var c=this.serialize({header:{command:"sdp",sender:{id:this.call.getPid()},receiver:{id:a}},body:{data:{type:"offer",sdp:JSON.stringify(b)}}});w.base.sendOfferSdp.call(this,c)},sendAnswerSdp:function(a,b){var c=this.serialize({header:{command:"sdp",sender:{id:this.call.getPid()},receiver:{id:a}},body:{data:{type:"answer",sdp:JSON.stringify(b)}}});w.base.sendAnswerSdp.call(this,c)},signalEnd:function(a){var b=this.serialize({header:{command:"end",token:this.call.getToken(),sender:{id:this.call.getPid()},receiver:{type:"server"}},body:{data:{target:a}}});w.base.signalEnd.call(this,b)},message:function(b){var c=JSON.parse(b.data),d=c.header,e=c.body,f=d.command.toUpperCase(),g=null;if("res"===d.commandType&&"SUCCESS"!==o[e.header.code])return t.error("cdm",{klass:"Signaling",method:"message",channelId:this.call.getChannelId(),message:"Received message. data = "+b.data}),void a.call(this,"SIGNAL",e.header.code,c);switch(f){case"CONNECT":t.trace("cdm",{klass:"Signaling",method:"message",channelId:this.call.getChannelId(),message:"Received signal 'connect'. data = "+b.data}),this.fire("connect",e.data?e.data.targetId||void 0:void 0);break;case"ON_CONNECT":t.trace("cdm",{klass:"Signaling",method:"message",channelId:this.call.getChannelId(),message:"Received signal 'on_connect'. data = "+b.data}),this.fire("notiConnect",e.data.targetId);break;case"SDP":if("res"===d.commandType)return;g=e.data.type.toUpperCase(),"OFFER"===g?this.fire("receiveOfferSdp",d.sender.id,JSON.parse(e.data.sdp)):"ANSWER"===g&&this.fire("receiveAnwserSdp",d.sender.id,JSON.parse(e.data.sdp));break;case"CANDIDATE":if("res"===d.commandType)return;this.fire("receiveCandidate",d.sender.id,JSON.parse(e.data.candidate))}}}),x=l.Extend(l.Event,{initialize:function(a,b){x.base.initialize.call(this),this.token=null,this.restServer=a.rest,this.socketServer=a.webSocket,this.call=b,this.apiVersion="v1",this.socket=null,this.isTurnSuccess=!1,this.inteval=null,t.trace("cdm",{klass:"NAGSignalManager",method:"initialize",channelId:this.call.getChannelId(),message:"Created instance of 'NAGSignalManager'"})},requestAjax:function(a,b,c,d,e,f){var g=new XMLHttpRequest;g.onreadystatechange=l.bind(function(a){var b=a.target,c=b.responseText;try{4===b.readyState&&200===b.status&&c?(c=JSON.parse(c),e.call(this,c)):4===b.readyState&&200!==b.status&&(c=JSON.parse(c),f.call(this,b,c))}catch(a){f.call(this,b,c)}},this),g.open(a,b,!0),"firefox"===l.browser.name&&g.setRequestHeader("Accept","application/json"),g.setRequestHeader("Content-Type",c),g.send(d)},userRegistration:function(){function a(a){if(!a.data.status||"FAIL"===a.data.status)return t.error("cdm",{klass:"NAGSignalManager",method:"userRegistration",channelId:this.call.getChannelId(),message:"Failed to register Nag user. data = "+JSON.stringify(a)}),void this.fire("error","S4401",n.S4401,a);t.trace("cdm",{klass:"NAGSignalManager",method:"userRegistration",channelId:this.call.getChannelId(),message:"Registered to be success. data = "+JSON.stringify(a)}),this.setToken(a.data.authToken),t.trace("cdm",{klass:"NAGSignalManager",method:"userRegistration",channelId:this.call.getChannelId(),message:"WebSocket["+this.socketServer+"] Created instance of 'Nag Notification's Socket'"});try{this.socket=new r(this.socketServer),this.socket.on("open",this.open,this).on("message",this.message,this).on("error",this.error,this).on("close",this.close,this),this.inteval=window.setInterval(l.bind(this.open,this),25e4)
}catch(b){return t.error("cdm",{klass:"NAGSignalManager",method:"userRegistration",channelId:this.call.getChannelId(),message:"Failed to create instance of 'Notification Web Socket'"}),void this.fire("error","S4402",n.S4402)}}function b(a,b){t.error("cdm",{klass:"NAGSignalManager",method:"userRegistration",channelId:this.call.getChannelId(),message:"Status["+a.status+"] Failed to register Nag user. data = "+JSON.stringify(b)}),this.fire("error","S4401",n.S4401,b)}t.trace("cdm",{klass:"NAGSignalManager",method:"userRegistration",channelId:this.call.getChannelId(),message:"Requested to register Nag user"});var c={data:{userExpires:"84600"}},d=this.call.playRtc.config.url+"/v2/playrtc/signal/user/"+this.call.getPid().substr(2);this.requestAjax("post",d,"application/json; charset=UTF-8",JSON.stringify(c),a,b)},userDeletion:function(){function a(){t.trace("cdm",{klass:"NAGSignalManager",method:"userDeletion",channelId:this.call.getChannelId(),message:"Deleted to be success"})}function b(a){t.error("cdm",{klass:"NAGSignalManager",method:"userDeletion",channelId:this.call.getChannelId(),message:"Status["+a.status+"] Failed to delete Nag user"})}t.trace("cdm",{klass:"NAGSignalManager",method:"userDeletion",channelId:this.call.getChannelId(),message:"Requested to delete Nag user"});var c=this.call.playRtc.config.url+"/v2/playrtc/signal/user/"+this.call.getPid().substr(2);this.requestAjax("delete",c,"application/json; charset=UTF-8","{}",a,b)},requestTurnServer:function(a){function b(b){t.trace("cdm",{klass:"NAGSignalManager",method:"userDeletion",channelId:this.call.getChannelId(),message:"Got nag turn servers. data = "+JSON.stringify(b)});var c=[{url:"turn:"+b.data.turnserver.turnIp+":"+b.data.turnserver.turnPort,credential:b.data.turnserver.turnPw,username:b.data.turnserver.turnId}];this.fire("nagTurnList",[c]),a(c)}function c(a){t.error("cdm",{klass:"NAGSignalManager",method:"requestTurnServer",channelId:this.call.getChannelId(),message:"Status["+a.status+"] Failed to request NAG TURN Server"})}t.trace("cdm",{klass:"NAGSignalManager",method:"requestTurnServer",channelId:this.call.getChannelId(),message:"Requested nag turn server"});var d=this.call.playRtc.config.signalServer.rest+"/webrtcsignaling/"+this.getApiVersion()+"/"+this.call.getPid().substr(2)+"/turnserver?authToken="+this.getToken();this.requestAjax("get",d,"application/x-www-form-urlencoded","{}",b,c)},setToken:function(a){this.token=a},getToken:function(){return this.token},getApiVersion:function(){return this.apiVersion},open:function(){this.send(JSON.stringify({apiMethod:"POST",apiUrl:"/notificationchannel/"+this.getApiVersion()+"/"+this.call.getPid().substr(2)+"/channels",data:{authToken:this.getToken()}}))},error:function(){t.error("cdm",{klass:"NAGSignalManager",method:"error",channelId:this.call.getChannelId(),message:"Caused NAG Notification's socket error"})},close:function(){t.trace("cdm",{klass:"NAGSignalManager",method:"close",channelId:this.call.getChannelId(),message:"Closed NAG Notification's socket"})},send:function(a){this.socket.send(a)},message:function(a){var c=JSON.parse(a.data),d=null;if(c.requestError)return t.error("cdm",{klass:"NAGSignalManager",method:"message",channelId:this.call.getChannelId(),message:"Received data = "+a.data}),void b.call(this,c.requestError.serviceException.messageId,c);switch(d=c.service.toUpperCase()){case"WEBRTCSIGNALING":if(c.data.offer){if(c.data.offer.sdp)this.fire("receiveNagOfferSdp","PR"+c.data.originatorAddress,{sdp:c.data.offer.sdp,type:"offer"},c.data.sessionId);else if(c.data.offer.candidate)for(var e=0;e<c.data.offer.candidate.length;e++)this.fire("receiveNagCandidate",c.data.sessionId,c.data.offer.candidate[e])}else if(c.data.answer){if(c.data.answer.sdp)this.fire("receiveNagAnwserSdp",c.data.sessionId,{sdp:c.data.answer.sdp,type:"answer"});else if(c.data.answer.candidate)for(var e=0;e<c.data.answer.candidate.length;e++)this.fire("receiveNagCandidate",c.data.sessionId,c.data.answer.candidate[e])}else"ended"===c.data.status&&"no answer"===c.data.reason&&(t.error("cdm",{klass:"NAGSignalManager",method:"message",channelId:this.call.getChannelId(),message:"No answer"}),this.fire("error","S4408",n.S4408))}},destory:function(){this.socket&&this.socket.close(),this.inteval&&window.clearInterval(this.inteval),this.userDeletion()}}),y=s.Signaling.Extend({initialize:function(a,b,c){y.base.initialize.call(this,a,b),this.mgr=this.call.getNAGMgr(),this.timer=null,this.candidates=[],this.peerid=c,t.trace("cdm",{klass:"NAGSignalingAdapter",method:"initialize",channelId:this.call.getChannelId(),message:"Created instance of 'NAGSignalingAdapter'"})},createSignal:function(){y.base.createSignal.call(this),this.socket.on("message",this.message,this)},send:function(a){1===this.socket.getReadyState()?this.socket.send(a):this.fire("error","S4403",n.S4403)},connect:function(a){this.fire("connect",a)},sendCandidate:function(a,b){if(this.getSessionId()){t.trace("cdm",{klass:"NAGSignalingAdapter",method:"sendCandidate",channelId:this.call.getChannelId(),message:"Sent candidate"});var c=this.call.peers[a].type,d={apiMethod:"PUT",apiUrl:"/webrtcsignaling/"+this.mgr.getApiVersion()+"/"+this.call.getPid().substr(2)+"/sessions/"+this.getSessionId()+"/update",data:{authToken:this.mgr.getToken()}};d.data[c]=this.candidates.length>0?{candidate:this.candidates}:{candidate:[b]},y.base.sendCandidate.call(this,JSON.stringify(d)),this.candidates=[]}else t.trace("cdm",{klass:"NAGSignalingAdapter",method:"sendCandidate",channelId:this.call.getChannelId(),message:"Gathered candidate"}),this.candidates.push(b)},sendOfferSdp:function(a,b){var c={apiMethod:"POST",apiUrl:"/webrtcsignaling/"+this.mgr.getApiVersion()+"/"+this.call.getPid().substr(2)+"/sessions",data:{authToken:this.mgr.getToken(),originatorAddress:this.call.getPid().substr(2),participantAddress:a.substr(2),subject:"offer's sdp send.",callType:"web",offer:{sdp:""}}};c.data.offer.sdp=b.sdp,y.base.sendOfferSdp.call(this,JSON.stringify(c))},sendAnswerSdp:function(a,b){var c={apiMethod:"PUT",apiUrl:"/webrtcsignaling/"+this.mgr.getApiVersion()+"/"+this.call.getPid().substr(2)+"/sessions/"+this.getSessionId()+"/answer",data:{authToken:this.mgr.getToken(),answer:{sdp:""}}};c.data.answer.sdp=b.sdp,y.base.sendAnswerSdp.call(this,JSON.stringify(c))},signalEnd:function(){this.socket.close()},getSessionId:function(){return this.call.peers[this.peerid].sessionId},setSessionId:function(a){this.call.peers[this.peerid].sessionId=a},message:function(a){var c=JSON.parse(a.data),d=null;if(c.requestError)return t.error("cdm",{klass:"NAGSignalingAdapter",method:"message",channelId:this.call.getChannelId(),message:"Received data = "+a.data}),void b.call(this,c.requestError.serviceException.messageId,c);switch(t.trace("cdm",{klass:"NAGSignalingAdapter",method:"message",channelId:this.call.getChannelId(),message:"Received data = "+a.data}),d=c.service.toUpperCase()){case"WEBRTCSIGNALING":"trying"===c.data.status&&this.setSessionId(c.data.sessionId)}}}),z=l.Extend(l.Event,{initialize:function(a,b,c,d,e){z.base.initialize.call(this),this.config=l.apply({iceServers:null,dataChannelEnabled:!1},e),this.call=a,this.id=b,this.uid=c,this.localStream=d,this.media=null,t.trace("cdm",{klass:"Peer",method:"initialize",channelId:this.call.getChannelId(),message:"Created instance of 'Peer'"})},setEvent:function(){var a=this.pc;a.onicecandidate=l.bind(function(a){t.trace("cdm",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),message:"Created candidate. candidate = "+JSON.stringify(a.candidate)}),a.candidate&&this.fire("sendCandidate",this.id,a.candidate)},this),a.onaddstream=l.bind(function(a){this.fire("addRemoteStream",this.id,this.uid,a.stream),this.media=new A(a.stream)},this),a.onsignalingstatechange=l.bind(function(a){this.fire("signalingstatechange",a)},this),a.oniceconnectionstatechange=l.bind(function(a){this.fire("iceconnectionstatechange",a);var b=a.target.iceConnectionState.toUpperCase(),c=a.target.iceGatheringState.toUpperCase();t.trace("cdm",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),message:"ConnectionState["+b+"] GatheringState["+c+"] Changed P2P's state"}),("COMPLETED"===b||"CONNECTED"===b||"FAILED"===b)&&this.fire("signalEnd",this.id),"FAILED"===b?(t.error("cndm",{klass:"Peer",method:"setEvent",service:"P2P",stateCode:50301,errorCode:40206,isSuccess:"N",token:this.call.getToken(),channelId:this.call.getChannelId(),myPeerId:this.call.getPid(),myUserId:this.call.getUid(),yourPeerId:this.id,yourUserId:this.uid,message:"PID["+this.call.getPid()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Failed P2P connection"}),this.fire("error","P4501",n.P4501)):"CHECKING"===b?this.fire("stateChange","CHECKING",this.id,this.uid):"COMPLETED"===b||"CONNECTED"===b?(this.connected||t.trace("cndm",{klass:"Peer",method:"setEvent",service:"P2P",stateCode:50301,errorCode:20001,isSuccess:"Y",token:this.call.getToken(),channelId:this.call.getChannelId(),myPeerId:this.call.getPid(),myUserId:this.call.getUid(),yourPeerId:this.id,yourUserId:this.uid,message:"PID["+this.call.getPid()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Connected P2P"}),this.connected=!0,this.fire("stateChange","CONNECTED",this.id,this.uid)):"DISCONNECTED"===b&&this.fire("stateChange","DISCONNECTED",this.id,this.uid)},this),a.onremovestream=l.bind(function(a){this.fire("removestream",a)},this),a.onclose=l.bind(function(a){this.fire("close",a)},this)},createPeerConnection:function(){t.trace("cdm",{klass:"Peer",method:"createPeerConnection",channelId:this.call.getChannelId(),message:"PID["+this.id+"] Created instance of 'Native PeerConnection'"}),console.log(" iceServers = "+JSON.stringify(this.config.iceServers)),this.pc=new f({iceServers:this.config.iceServers},{optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!1}]}),this.setEvent(),this.localStream&&this.pc.addStream(this.localStream),l.dataChannelSupport&&this.config.dataChannelEnabled?(this.data=new B(this),this.data.on("open",l.bind(function(){this.call.playRtc.fire("addDataStream",this.id,this.uid,this.data)},this))):this.config.dataChannelEnabled&&t.warn("cndm",{klass:"Peer",method:"createPeerConnection",service:"P2P",stateCode:50401,errorCode:40207,isSuccess:"N",token:this.call.getToken(),channelId:this.call.getChannelId(),myPeerId:this.call.getPid(),myUserId:this.call.getUid(),yourPeerId:this.id,yourUserId:this.uid,message:"PID["+this.id+"] Didn't create data channel"})},createOffer:function(){this.createPeerConnection(),this.pc.createOffer(l.bind(function(a){t.trace("cdm",{klass:"Peer",method:"createOffer",channelId:this.call.getChannelId(),message:"Create offer sdp. offerSdp = "+JSON.stringify(a)}),this.pc.setLocalDescription(a),this.fire("sendOfferSdp",this.id,a)},this),l.bind(function(){t.error("cndm",{klass:"Peer",method:"createOffer",service:"P2P",stateCode:50205,errorCode:40203,isSuccess:"N",token:this.call.getToken(),channelId:this.call.getChannelId(),myPeerId:this.call.getPid(),myUserId:this.call.getUid(),yourPeerId:this.id,yourUserId:this.uid,message:"Failed to create offer sdp"}),this.fire("error","S4404",n.S4404)},this))},createAnswer:function(a){this.pc||this.createPeerConnection();var b=this.pc;try{b.setRemoteDescription(new g(a)),t.trace("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Set offer sdp. offerSdp = "+JSON.stringify(a)})}catch(c){return t.error("cndm",{klass:"Peer",method:"createAnswer",service:"SGL",stateCode:50206,errorCode:40204,isSuccess:"N",token:this.call.getToken(),channelId:this.call.getChannelId(),myPeerId:this.call.getPid(),myUserId:this.call.getUid(),yourPeerId:this.id,yourUserId:this.uid,message:"OtherPID["+this.id+"] Failed to set offer sdp"}),void this.fire("error","S4405",n.S4405)}b.createAnswer(l.bind(function(a){t.trace("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"Created answer sdp. answerSdp = "+JSON.stringify(a)}),this.pc.setLocalDescription(a),this.fire("sendAnswerSdp",this.id,a)},this),l.bind(function(){t.error("cndm",{klass:"Peer",method:"createAnswer",service:"SGL",stateCode:50205,errorCode:40203,isSuccess:"N",token:this.call.getToken(),channelId:this.call.getChannelId(),myPeerId:this.call.getPid(),myUserId:this.call.getUid(),yourPeerId:this.id,yourUserId:this.uid,message:"Failed to create answer sdp"}),this.fire("error","S4404",n.S4404)},this))},receiveAnwserSdp:function(a){var b=this.pc;try{b.setRemoteDescription(new g(a)),t.trace("cdm",{klass:"Peer",method:"receiveAnwserSdp",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Set anwser sdp. anwserSdp = "+JSON.stringify(a)})}catch(c){t.error("cndm",{klass:"Peer",method:"receiveAnwserSdp",service:"SGL",stateCode:50206,errorCode:40204,isSuccess:"N",token:this.call.getToken(),channelId:this.call.getChannelId(),myPeerId:this.call.getPid(),myUserId:this.call.getUid(),yourPeerId:this.id,yourUserId:this.uid,message:"OtherPID["+this.id+"] Failed to set offer sdp"}),this.fire("error","S4405",n.S4405)}},receiveCandidate:function(a){this.pc||this.createPeerConnection();var b=this.pc;try{a=new h(a),b.addIceCandidate(a),t.trace("cdm",{klass:"Peer",method:"receiveAnwserSdp",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Set candidate. candidate = "+a})}catch(c){t.error("cndm",{klass:"Peer",method:"receiveCandidate",service:"SGL",stateCode:50208,errorCode:40205,isSuccess:"N",token:this.call.getToken(),channelId:this.call.getChannelId(),myPeerId:this.call.getPid(),myUserId:this.call.getUid(),yourPeerId:this.id,yourUserId:this.uid,message:"OtherPID["+this.id+"] Failed to set candidate"}),this.fire("error","S4406",n.S4406)}},close:function(){this.pc&&this.pc.close(),this.pc=null},getDataChannel:function(){return this.data},getMedia:function(){return this.media?this.media:null},getPeerConnection:function(){return this.pc},getStats:function(a){this.pc.getStats(l.bind(function(b){var c=[];b.result().forEach(function(a){var b={};a.names().forEach(function(c){b[c]=a.stat(c)}),b.id=a.id,b.type=a.type,b.timestamp=a.timestamp,b.media=b.hasOwnProperty("audioInputLevel")?"local-audio":b.hasOwnProperty("googFrameHeightSent")?"local-video":b.hasOwnProperty("audioOutputLevel")?"remote-audio":b.hasOwnProperty("googFrameHeightReceived")?"remote-video":"none",c.push(b)}),a.call(this,c)},this))}}),A=function(){if(!l.blobWorkerSupport)return!1;var a=window.AudioContext||window.webkitAudioContext,b=function(){function a(a,b){for(var c=new Float32Array(b),d=0,e=a.length,f=0,g=null;e>f;f++)g=a[f],c.set(g,d),d+=g.length;return c}function b(a,b){for(var c=a.length+b.length,d=new Float32Array(c),e=0,f=0;c>e;)d[e++]=a[f],d[e++]=b[f],f++;return d}function c(a,b){var c=new ArrayBuffer(44+2*a.length),f=new DataView(c);return e(f,0,"RIFF"),f.setUint32(4,32+2*a.length,!0),e(f,8,"WAVE"),e(f,12,"fmt "),f.setUint32(16,16,!0),f.setUint16(20,1,!0),f.setUint16(22,b?1:2,!0),f.setUint32(24,sampleRate,!0),f.setUint32(28,4*sampleRate,!0),f.setUint16(32,4,!0),f.setUint16(34,16,!0),e(f,36,"data"),f.setUint32(40,2*a.length,!0),d(f,44,a),f}function d(a,b,c){for(var d=0;d<c.length;d++,b+=2){var e=Math.max(-1,Math.min(1,c[d]));a.setInt16(b,0>e?32768*e:32767*e,!0)}}function e(a,b,c){for(var d=0;d<c.length;d++)a.setUint8(b+d,c.charCodeAt(d))}function f(){recLength=0,recBuffersL=[],recBuffersR=[],sampleRate=null}function g(a,b,c){recBuffersL.push(new Float32Array(b)),recBuffersR.push(new Float32Array(c)),recLength+=a}function h(){var d=a(recBuffersL,recLength),e=a(recBuffersR,recLength),f=b(d,e),g=c(f),h=new Blob([g],{type:"audio/wav"});postMessage(h)}var i=function(a){var b=a.data,c=b.type;"init"===c?sampleRate=b.sampleRate:"record"===c?g(b.length,b.leftBuf,b.rightBuf):"export"===c&&(h(),f())}.toString(),j=new Blob(["var recLength = 0, recBuffersL = [], recBuffersR = [], sampleRate = null;",a.toString(),b.toString(),c.toString(),d.toString(),e.toString(),f.toString(),g.toString(),h.toString(),"this.onmessage = "+i],{type:"application/javascript"});j=k.createObjectURL(j);var l=new Worker(j);return k.revokeObjectURL(j),l}(),c=function(a){this.stream=a};c.prototype.start=function(){var c=new a,d=(c.createAnalyser(),c.createMediaStreamSource(this.stream)),e=c.createScriptProcessor(2048);d.connect(e),d.connect(c.destination),e.connect(c.destination),e.onaudioprocess=function(a){b.postMessage({type:"record",length:a.inputBuffer.length,leftBuf:a.inputBuffer.getChannelData(0),rightBuf:a.inputBuffer.getChannelData(1)})},b.postMessage({type:"init",sampleRate:c.sampleRate})},c.prototype.stop=function(a){b.onmessage=function(b){var c=b.data;a(c)},b.postMessage({type:"export"})};var d=function(a){this.stream=a,this.mr=new MediaRecorder(this.stream),this.array=[],this.mr.ondataavailable=l.bind(function(a){this.array.push(a.data)},this)};return d.prototype.start=function(){this.mr.start(1e3)},d.prototype.stop=function(a){this.mr.stop();var b=new Blob(this.array,{type:"video/webm"});a(b)},l.Extend(l.Event,{initialize:function(a){A.base.initialize.call(this),this.stream=a,this.recorder=null},createRecorder:function(a){var b=null,e=this.getStream();switch(a){case"AUDIO":b=new c(e);break;case"VIDEO":l.mediaRecorderSupport?b=new d(e):t.warn("cdm",{klass:"Media",method:"createRecorder",message:"Media Recorder is not suporrted"});break;default:t.warn("cdm",{klass:"Media",method:"createRecorder",message:"Must select recorder"})}return b},record:function(a){this.recorder||(t.trace("cdm",{klass:"Media",method:"record",message:"Type["+a+"] Started record"}),a=a.toUpperCase(),this.recorder=this.createRecorder(a),this.recorder&&this.recorder.start())},recordStop:function(a){if(this.recorder){if(!a)return void t.error("cdm",{klass:"Media",method:"recordStop",message:"Failed to execute 'recordStop' on 'Media': 1 arguments required, but only "+arguments.length+" present"});t.trace("cdm",{klass:"Media",method:"recordStop",message:"Stopped record"}),this.recorder.stop(a),this.recorder=null}},getStream:function(){return this.stream},getVideoTrack:function(){var a=this.getStream(),b=a.getVideoTracks();return b.length>0?b[0]:null},getAudioTrack:function(){var a=this.getStream(),b=a.getAudioTracks();return b.length>0?b[0]:null},audioMute:function(a){var b=this.getAudioTrack();return b?(b.enabled=a,!0):!1},videoMute:function(a){var b=this.getVideoTrack();return b?(b.enabled=a,!0):!1},mute:function(a){this.audioMute(a),this.videoMute(a)},stop:function(){this.stream.stop()}})}();if("ie"===l.browser.name)var A=l.Extend(l.Event,{initialize:function(a,b){A.base.initialize.call(this);var c=e(),d='<object id="'+c+'" width="100%" height="100%" classid="CLSID:51B747D6-B9C1-4A5F-8843-EBC25F6395A5"></object>',f=document.getElementById(a);f.innerHTML=d,this.object=document.getElementById(c),this.object.zorder=b},setSrc:function(a){this.stream=a,this.object.src=a},getStream:function(){return this.stream},audioMute:function(a){return this.stream?(this.stream.setAudioMute(a),!0):!1},videoMute:function(a){return this.stream?(this.stream.setVideoMute(a),!0):!1},mute:function(a){this.audioMute(a),this.videoMute(a)},setViewSize:function(a,b){this.object.width=a,this.object.height=b},stop:function(){this.object&&this.object.removeNode(),this.object=null}});var B=function(){function a(){return(new Date).getTime()}function b(a,b){var c=new Uint8Array(a.byteLength+b.byteLength);return c.set(new Uint8Array(a),0),c.set(new Uint8Array(b),a.byteLength),c.buffer}if(!l.blobWorkerSupport)return!1;var c={0:"text",1:"file"},d={0:"master",1:"frag"},e=function(){var a=function(a){var b=a.data,c=null;FileReaderSync?(c=new FileReaderSync,postMessage(c.readAsArrayBuffer(b))):(c=new FileReader,c.onload=function(a){postMessage(a.target.result)},c.readAsArrayBuffer(b))},b=new Blob(["this.onmessage = "+a.toString()],{type:"application/javascript"});return b=k.createObjectURL(b)},f=function(){var a=function(a){var b=a.data,c=null;FileReaderSync?(c=new FileReaderSync,postMessage(c.readAsArrayBuffer(b))):(c=new FileReader,c.onload=function(a){postMessage(a.target.result)},c.readAsArrayBuffer(b))},b=new Blob(["this.onmessage = "+a.toString()],{type:"application/javascript"});b=k.createObjectURL(b);var c=new Worker(b);return k.revokeObjectURL(b),c}(),g={},h={};return l.Extend(l.Event,{initialize:function(a){B.base.initialize.call(this),this.peer=a,this.sending=!1,this.queue=[],this.dataChannel=this.peer.getPeerConnection().createDataChannel("channel",{id:1}),this.setEvent(),t.trace("cndm",{klass:"Data",method:"initialize",service:"P2P",stateCode:50401,errorCode:20001,isSuccess:"Y",token:this.peer.call.getToken(),channelId:this.peer.call.getChannelId(),myPeerId:this.peer.call.getPid(),myUserId:this.peer.call.getUid(),yourPeerId:this.peer.id,yourUserId:this.peer.uid,message:"OtherPID["+a.id+"] Created instance of 'Data'"})},setEvent:function(){function a(a){var b=new DataView(a),d=b.getFloat64(0),e=b.getInt32(20);try{g[d]?this.textReceive(d,b,a):h[d]?this.fileReceive(d,b,a):"text"===c[e]?this.textReceive(d,b,a):this.fileReceive(d,b,a)}catch(f){t.error("cndm",{klass:"Data",method:"setEvent",service:"P2P",stateCode:50403,errorCode:40208,isSuccess:"N",token:this.peer.call.getToken(),channelId:this.peer.call.getChannelId(),myPeerId:this.peer.call.getPid(),myUserId:this.peer.call.getUid(),yourPeerId:this.peer.id,yourUserId:this.peer.uid,message:"OtherPID["+this.peer.id+"] Failed to receive message"}),this.fire("error",f)}}var b=this.dataChannel;b.onopen=l.bind(function(a){t.trace("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"OtherPID["+this.peer.id+"] Opened dataChannel"}),this.fire("open",a)},this),b.onclose=l.bind(function(a){t.trace("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"OtherPID["+this.peer.id+"] Closed dataChannel"}),this.fire("close",a)},this),b.onerror=l.bind(function(a){t.error("cndm",{klass:"Data",method:"setEvent",service:"P2P",stateCode:50404,errorCode:40207,isSuccess:"N",token:this.peer.call.getToken(),channelId:this.peer.call.getChannelId(),myPeerId:this.peer.call.getPid(),myUserId:this.peer.call.getUid(),yourPeerId:this.peer.id,yourUserId:this.peer.uid,message:"OtherPID["+this.peer.id+"] Caused error"}),this.fire("error",a)},this),f.onmessage=l.bind(function(b){a.call(this,b.data)},this),b.onmessage=l.bind(function(b){t.trace("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"OtherPID["+this.peer.id+"] Received message"}),"chrome"===l.browser.name?a.call(this,b.data):f.postMessage(b.data)},this)},send:function(a,b,c){a.size&&a.type&&a.name?(this.sending?this.queue.push({message:a,success:b,error:c}):this.sendFile(a,b,c),this.sending=!0):this.sendText(a,b,c)},bufferedSend:function(a){var b=this.dataChannel;try{b.send(a),t.trace("cdm",{klass:"Data",method:"bufferedSend",channelId:this.peer.call.getChannelId(),message:"Sent message"})}catch(c){return this.fire("error",c),t.error("cndm",{klass:"Data",method:"bufferedSend",service:"P2P",stateCode:50402,errorCode:40207,isSuccess:"N",token:this.peer.call.getToken(),channelId:this.peer.call.getChannelId(),myPeerId:this.peer.call.getPid(),myUserId:this.peer.call.getUid(),yourPeerId:this.peer.id,yourUserId:this.peer.uid,message:"Failed to send dataChannel message error"}),!1}return!0},sendText:function(c,d,e){var f=(this.dataChannel,a()),g=new ArrayBuffer(20),h=new DataView(g);h.setFloat64(0,f),h.setInt32(8,1);for(var i=l.bind(function(a,f,g){var j=f[g];return this.bufferedSend(b(a,j))?void(g+1<f.length?window.setTimeout(function(){var a=g+1;h.setInt32(12,a),h.setInt32(16,f[a].byteLength),i(h.buffer,f,a)},10):d&&d(c)):void(e&&e(c))},this),j=new ArrayBuffer(2*c.length),k=new Uint8Array(j),m=0,n=null,o=c.length,p=0;o>m;m++)n=c.charCodeAt(m),k[p]=n>>>8,k[p+1]=255&n,p+=2;var q=this.packetSplit(j,66488),r=new ArrayBuffer(36),s=new DataView(r);s.setFloat64(0,f),s.setInt32(8,0),s.setFloat64(12,j.byteLength),s.setInt32(20,0),s.setInt32(24,q.length),s.setInt32(28,0),s.setInt32(32,q[0].byteLength),i(s.buffer,q,0)},sendFile:function(c,d,f){var g=(this.dataChannel,a()),h=c.name,i=c.type,j=new ArrayBuffer(20),m=new DataView(j);m.setFloat64(0,g),m.setInt32(8,1);var n=l.bind(function(a,e,g){var h=e[g];return this.bufferedSend(b(a,h))?void(g+1<e.length?window.setTimeout(function(){var a=g+1;m.setInt32(12,a),m.setInt32(16,e[a].byteLength),n(m.buffer,e,a)},100):(this.sending=!1,d&&d(c),nextData=this.queue.pop(),nextData&&this.send(nextData.message,nextData.success,nextData.error))):void(f&&f(c))},this),o=e(),p=new Worker(o);k.revokeObjectURL(o),p.onmessage=l.bind(function(a){var b=this.packetSplit(a.data,65978),c=new ArrayBuffer(548),d=new DataView(c),e=null;d.setFloat64(0,g),d.setInt32(8,0),d.setFloat64(12,a.data.byteLength),d.setInt32(20,1);for(var f=24,j=0;280>f;f+=2)e=h.charCodeAt(j),e&&(d.setUint8(f,e>>>8),d.setUint8(f+1,255&e)),j++;for(var f=280,j=0;536>f;f+=2)e=i.charCodeAt(j),e&&(d.setUint8(f,e>>>8),d.setUint8(f+1,255&e)),j++;d.setInt32(536,b.length),d.setInt32(540,0),d.setInt32(544,b[0].byteLength),n(d.buffer,b,0)},this),p.postMessage(c)},textReceive:function(a,c,e){var f={},h=null,i=c.getInt32(8);if(f.peerId=this.peer.id,"master"===d[i]?(f.id=a,f.totalSize=c.getFloat64(12),f.fragCount=c.getInt32(24),f.fragIndex=c.getInt32(28),f.fragSize=c.getInt32(32),h=e.slice(36),g[a]={},g[a].totalSize=f.totalSize,g[a].fragCount=f.fragCount,g[a][f.fragIndex]=h):(f.id=a,f.totalSize=g[a].totalSize,f.fragCount=g[a].fragCount,f.fragIndex=c.getInt32(12),f.fragSize=c.getInt32(16),h=e.slice(20),g[a][f.fragIndex]=h),this.fire("progress",f),f.fragCount-1===f.fragIndex){for(var j=f.fragCount,k=g[a],l=new ArrayBuffer(0),m=null,n=[],o=0,p=0;j>o;o++)l=b(l,k[o]);for(o=0,m=new Uint8Array(l),p=l.byteLength;p>o;)n.push((255&m[o++])<<8|255&m[o++]);if(!this.hasEvent("message"))return alert("You must create message's event."),!1;this.fire("message",{type:"text",id:a,peerId:this.peer.id,totalSize:k.totalSize,data:String.fromCharCode.apply(null,n)})}},fileReceive:function(a,c,e){var f={},g=null,j=c.getInt32(8),k=null,l=null,m=null,n=null,k=null;if(f.peerId=this.peer.id,"master"===d[j]){for(f.totalSize=c.getFloat64(12),f.fileName="",i=24;280>i;i+=2)l=String.fromCharCode(c.getInt16(i)),0!==l.charCodeAt(0)&&(f.fileName=f.fileName+l);for(f.mimeType="",i=280;536>i;i+=2)l=String.fromCharCode(c.getInt16(i)),0!==l.charCodeAt(0)&&(f.mimeType=f.mimeType+l);f.id=a,f.fragCount=c.getInt32(536),f.fragIndex=c.getInt32(540),f.fragSize=c.getInt32(544),g=e.slice(548),h[a]={},h[a].totalSize=f.totalSize,h[a].fileName=f.fileName,h[a].mimeType=f.mimeType,h[a].fragCount=f.fragCount,h[a][f.fragIndex]=g}else f.id=a,f.fileName=h[a].fileName,f.mimeType=h[a].mimeType,f.totalSize=h[a].totalSize,f.fragCount=h[a].fragCount,f.fragIndex=c.getInt32(12),f.fragSize=c.getInt32(16),g=e.slice(20),h[a][f.fragIndex]=g;if(this.fire("progress",f),f.fragCount-1===f.fragIndex){for(m=f.fragCount,n=new ArrayBuffer(0),i=0;m>i;i++)n=b(n,h[a][i]);if(k=new Blob([n],{type:h[a].mimeType}),!this.hasEvent("message"))return h[a]=null,alert("You must create message's event."),!1;this.fire("message",{type:"file",id:a,peerId:this.peer.id,fileName:h[a].fileName,mimeType:h[a].mimeType,totalSize:h[a].totalSize,blob:k}),h[a]=null}},packetSplit:function(a,b){for(var c=[],d=b,e=a.byteLength,f=Math.ceil(e/d),g=0;f>g;g++)c.push(a.slice(g*d,(g+1)*d));return c},close:function(){this.dataChannel.close(),this.peer.data=null}})}();if("ie"===l.browser.name)var B=l.Extend(l.Event,{initialize:function(a){B.base.initialize.call(this),this.dataChannel=a,this.dataChannel.on("onMessage",l.bind(function(a,b,c,d,e){window.setTimeout(l.bind(function(){var a=JSON.parse(d),c={peerId:b,id:a.id,totalSize:a.totalSize,fragCount:a.fragCount,fragIndex:a.fragIndex,fragSize:a.fragSize,type:a.type,fileName:a.fileName||"",mimeType:a.mimeType||"",data:e};this.fire("message",c)},this),100)},this)),this.dataChannel.on("onProgress",l.bind(function(a,b,c,d){window.setTimeout(l.bind(function(){var a=JSON.parse(d),c={peerId:b,id:a.id,totalSize:a.totalSize,fragCount:a.fragCount,fragIndex:a.fragIndex,fragSize:a.fragSize,type:a.type,fileName:a.fileName,mimeType:a.mimeType};this.fire("progress",c)},this),100)},this)),this.dataChannel.on("onError",l.bind(function(a,b,c,d,e){window.setTimeout(l.bind(function(){var a={peerId:b,code:d,desc:e};this.fire("error",a)},this),100)},this))},sendText:function(a,b,c){this.dataChannel.sendText(a,b,c)},sendFile:function(a,b,c){this.dataChannel.sendFile(a,b,c)}});var C=null;!function(){var a=function(a,b,c,d){var e=new XMLHttpRequest;e.onreadystatechange=l.bind(function(a){var b=a.target,e=b.responseText;4===b.readyState&&200===b.status&&e?(e=JSON.parse(e),c.call(this,b,e)):4===b.readyState&&200!==b.status&&d.call(this,b)},this),e.open(b,a,!0),e.setRequestHeader("Content-Type","application/json; charset=UTF-8"),e.send("{}")};C=l.Extend(l.Event,{initialize:function(a){C.base.initialize.call(this),this.url=a},setRoom:function(a){this.room=a},getUser:function(){return this.user},setUser:function(a){this.user=a},getRoomList:function(b){function c(a,c){if(b)if(c.status&&"SUCCESS"===c.status){var d=c.result;b(d,"success",a)}else{var d={code:c.errcode,desc:c.desc};b(d,"error",a)}}function d(a){b&&b(null,"error",a)}var e=this.url+"/channel/rooms/";a(e,"get",c,d)},getRoomInfo:function(b){function c(a,c){if(c.status&&"SUCCESS"===c.status){var d=c.result;b(d,"success",a)}else{var d={code:c.errcode,desc:c.desc};b(d,"error",a)}}function d(a){b&&b(null,"error",a)}if(!this.room)return!1;var e=this.url+"/channel/rooms/"+this.room;a(e,"get",c,d)},getUserList:function(b){function c(a,c){if(b)if(c.status&&"SUCCESS"===c.status){var d=c.result;b(d,"success",a)}else{var d={code:c.errcode,desc:c.desc};b(d,"error",a)}}function d(a){b&&b(null,"error",a)}if(!this.room)return!1;var e=this.url+"/channel/rooms/"+this.room+"/users/";a(e,"get",c,d)},getUserInfo:function(b,c){function d(a,b){if(c)if(b.status&&"SUCCESS"===b.status){var d=b.result;c(d,"success",a)}else{var d={code:b.errcode,desc:b.desc};c(d,"error",a)}}function e(a){c&&c(null,"error",a)}if(!this.room||!b)return!1;var f=this.url+"/channel/rooms/"+this.room+"/users/"+b;a(f,"get",d,e)},searchUser:function(b,c){function d(a,b){if(c)if(b.status&&"SUCCESS"===b.status){var d=b.result;c(d,"success",a)}else{var d={code:b.errcode,desc:b.desc};c(d,"error",a)}}function e(a){c&&c(null,"error",a)}if(!b)return!1;var f=this.url+"/channel/users/"+b;a(f,"get",d,e)}})}();var D=null;return function(){var a=function(a,b,c,d,e){var f=new XMLHttpRequest;f.onreadystatechange=l.bind(function(a){var b=a.target,c=b.responseText;4===b.readyState&&200===b.status&&c?(c=JSON.parse(c),d.call(this,b,c)):4===b.readyState&&200!==b.status&&e.call(this,b)},this),f.open(b,a,!0),f.setRequestHeader("Content-Type","application/json; charset=UTF-8"),c=c||"{}",f.send(c)};D=l.Extend(l.Event,{initialize:function(a){C.base.initialize.call(this),this.url=a},setRoom:function(a){this.room=a},getUser:function(){return this.user},setUser:function(a){this.user=a},enterRoom:function(b,c){function d(a,b){if(c)if(b.status&&"SUCCESS"===b.status){var d=b.result;c(d,"success",a)}else{var d={error:{code:b.errcode,desc:b.desc}};c(d,"error",a)}}function e(a){this.room=null,c&&c(null,"error",a)}b=JSON.stringify(b)||"{}";var f=this.url+"/channel/rooms/"+this.room+"/users/"+this.user;a(f,"post",b,l.bind(d,this),l.bind(e,this))},leaveRoom:function(b,c){function d(a,b){if(c)if(b.status&&"SUCCESS"===b.status){var d=b.result;c(d,"success",a)}else{var d={error:{code:b.errcode,desc:b.desc}};c(d,"error",a)}}function e(a){c&&c(null,"error",a)}if(!this.room)return!1;b=b||"";var f=this.url+"/channel/rooms/"+this.room+"/users/"+this.user+"/"+b;a(f,"delete","",d,e),this.room=null},registAuth:function(b,c,d){function e(a,b){if(d)if(b.status&&"SUCCESS"===b.status){var c=b.result;d(c,"success",a)}else{var c={error:{code:b.errcode,desc:b.desc}};d(c,"error",a)}}function f(a){d&&d(null,"error",a)}if(!this.room)return!1;var g=this.url+"/signal/auth/nag/"+b;a(g,"post","{}",l.bind(e,this),l.bind(f,this))
},log:function(b,c){function d(a,b){if(c)if(b.status&&"SUCCESS"===b.status){var d=b.result;c(d,"success",a)}else{var d={error:{code:b.errcode,desc:b.desc}};c(d,"error",a)}}function e(a){c&&c(null,"error",a)}if(!this.room)return!1;var f=this.url+"/system/log/";a(f,"post",b,l.bind(d,this),l.bind(e,this))}})}(),function(){var a=function(a,b,c,d){var e=new XMLHttpRequest;e.onreadystatechange=l.bind(function(a){var b=a.target,d=b.responseText;try{4===b.readyState&&200===b.status&&d?(d=JSON.parse(d),d.error?c.error(b,d):c.success(d)):4===b.readyState&&200!==b.status&&(d=JSON.parse(d),c.error(b,d))}catch(a){c.error(b,d)}},this),e.open(b,a,!0),e.setRequestHeader("Content-Type","application/json; charset=UTF-8"),e.send(d?JSON.stringify(d):"{}")};s.Helper={setUrl:function(a){this.url=a},initialize:function(){Helper.base.initialize.call(this)},createChannel:function(b,c,d){var e={success:function(a){c(a.channelId,a.token.tokenId,a.configuration)},error:function(a,b){d(a,b)}},f=this.url+"/v2/playrtc/channels/channel";a(f,"post",e,b)},connectChannel:function(b,c,d,e){var f={success:function(a){d(a.channelId,a.token.tokenId,a.configuration)},error:function(a,b){e(a,b)}},g=this.url+l.strFormat("/v2/playrtc/channels/channel/{0}",b);a(g,"put",f,c)},disconnectChannel:function(b,c,d,e){var f={success:function(){d()},error:function(a,b){e(a,b)}},g=this.url+l.strFormat("/v2/playrtc/channels/channel/{0}/peers/peer/{1}",b,c);a(g,"delete",f)},deleteChannel:function(b,c,d){var e={success:function(a){c(a)},error:function(a,b){d(a,b)}},f=this.url+l.strFormat("/v2/playrtc/channels/channel/{0}",b);a(f,"delete",e)},getChannelList:function(b,c){var d={success:function(a){t.trace("cdm",{klass:"Helper",method:"getChannelList",message:"Received to get channel list. data = "+JSON.stringify(a)}),b&&b(a)},error:function(a,b){t.error("cdm",{klass:"Helper",method:"getChannelList",message:"Status["+a.status+"] Failed to get channel list. data = "+JSON.stringify(b)}),c&&c(a,b)}},e=this.url+"/v2/playrtc/channels";a(e,"get",d)},getChannel:function(b,c,d){var e={success:function(a){t.trace("cdm",{klass:"Helper",method:"getChannel",message:"Received to get channel. data = "+JSON.stringify(a)}),c&&c(a)},error:function(a,b){t.error("cdm",{klass:"Helper",method:"getChannelList",message:"Status["+a.status+"] Failed to get channel. data = "+JSON.stringify(b)}),d&&d(a,b)}},f=this.url+l.strFormat("/v2/playrtc/channels/channel/{0}",b);a(f,"get",e)},getPeerList:function(b,c,d){var e={success:function(a){t.trace("cdm",{klass:"Helper",method:"getPeerList",message:"Received to get peer list. data = "+JSON.stringify(a)}),c&&c(a)},error:function(a,b){t.error("cdm",{klass:"Helper",method:"getPeerList",message:"Status["+a.status+"] Failed to get peer list. data = "+JSON.stringify(b)}),d&&d(a,b)}},f=this.url+l.strFormat("/v2/playrtc/channels/channel/{0}/peers",b);a(f,"get",e)},getPeer:function(b,c,d,e){var f={success:function(a){t.trace("cdm",{klass:"Helper",method:"getPeer",message:"Received to get peer. data = "+JSON.stringify(a)}),d&&d(a)},error:function(a,b){t.error("cdm",{klass:"Helper",method:"getPeer",message:"Status["+a.status+"] Failed to get peer. data = "+JSON.stringify(b)}),e&&e(a,b)}},g=this.url+l.strFormat("/v2/playrtc/channels/channel/{0}/peers/peer/{1}",b,c);a(g,"get",f)}}}(),function(a){Object.defineProperties(a,{version:{get:function(){return"1.0.6"}},utils:{get:function(){return l}}})}(s),f&&g&&h?l.webRtcSupport=!0:(t.warn("cdm",{message:"Your browser is not supported about WebRTC."}),l.webRtcSupport=!1),l.dataChannelSupport=function(a){try{var b=new f(a,{optional:[{RtpDataChannels:!0}]}),c=!0,d=null;try{d=b.createDataChannel("_support"),d.close()}catch(e){c=!1,t.warn("cdm",{tag:"utils",message:"DataChannel is not supported."})}}catch(e){c=!1,t.warn("cdm",{tag:"utils",message:"DataChannel is not supported."})}return c}(),s});